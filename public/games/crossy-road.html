<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Crossy Road Multiplayer</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .game-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      background: var(--bg-card);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .game-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .game-title {
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(135deg, #22c55e, #16a34a, #15803d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1rem;
      text-shadow: 0 0 30px rgba(34, 197, 94, 0.3);
    }

    .game-modes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .mode-card {
      background: var(--bg-card-hover);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .mode-card:hover {
      transform: translateY(-5px);
      border-color: #22c55e;
      box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
    }

    .mode-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      display: block;
    }

    .mode-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .mode-description {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
      font-size: 0.9rem;
    }

    .mode-btn {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1rem;
    }

    .mode-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 20px rgba(34, 197, 94, 0.4);
    }

    .game-area {
      display: none;
    }

    .game-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-card-hover);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      border-color: #22c55e;
      box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      color: var(--text-primary);
      font-size: 2rem;
      font-weight: bold;
    }

    .betting-section {
      background: var(--bg-card-hover);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .betting-title {
      text-align: center;
      color: var(--text-primary);
      font-weight: bold;
      margin-bottom: 1.5rem;
      font-size: 1.3rem;
    }

    .bet-amount {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 2rem;
    }

    .amount-btn {
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      font-weight: bold;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-card);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.3s;
    }

    .amount-btn:hover {
      transform: translateY(-2px);
      border-color: #22c55e;
    }

    .amount-btn.active {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-color: #22c55e;
      color: white;
    }

    .custom-bet {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .bet-input {
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-card);
      color: var(--text-primary);
      width: 150px;
    }

    .game-canvas-container {
      display: flex;
      justify-content: center;
      margin-bottom: 2rem;
      position: relative;
    }

    #gameCanvas {
      background: linear-gradient(135deg, #87ceeb, #6bb6d6);
      border: 3px solid #22c55e;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      max-width: 100%;
      height: auto;
    }

    .game-controls {
      text-align: center;
      margin-bottom: 2rem;
    }

    .control-btn {
      padding: 1rem 2rem;
      margin: 0.5rem;
      border: none;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 1rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
    }

    .btn-secondary {
      background: var(--bg-card-hover);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
    }

    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }

    .instructions {
      background: var(--bg-card-hover);
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      text-align: center;
    }

    .instructions h3 {
      color: var(--text-primary);
      margin-bottom: 1rem;
    }

    .control-keys {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }

    .key {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-weight: bold;
      color: var(--text-primary);
    }

    .game-status {
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      margin: 2rem 0;
      padding: 1.5rem;
      background: var(--bg-card-hover);
      border: 2px solid var(--border-color);
      border-radius: 12px;
    }

    .status-playing { color: #22c55e; }
    .status-gameover { color: #ef4444; }
    .status-win { color: #10b981; }

    .result-message {
      text-align: center;
      font-size: 1.3rem;
      font-weight: bold;
      margin: 2rem 0;
      padding: 1.5rem;
      border-radius: 12px;
      animation: resultAppear 0.5s ease-out;
    }

    @keyframes resultAppear {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .result-win {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 163, 74, 0.2));
      color: #22c55e;
      border: 2px solid #22c55e;
    }

    .result-lose {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
      color: #ef4444;
      border: 2px solid #ef4444;
    }

    .multiplayer-section {
      background: var(--bg-card-hover);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 2rem;
      display: none;
    }

    .leaderboard {
      background: var(--bg-card-hover);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .leaderboard-title {
      text-align: center;
      color: var(--text-primary);
      font-weight: bold;
      margin-bottom: 1rem;
    }

    .leaderboard-list {
      list-style: none;
      padding: 0;
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 0.5rem;
      transition: all 0.3s;
    }

    .leaderboard-item:hover {
      transform: translateX(5px);
      background: var(--bg-card-hover);
    }

    .leaderboard-rank {
      font-weight: bold;
      color: #22c55e;
      margin-right: 1rem;
    }

    .leaderboard-name {
      flex: 1;
      color: var(--text-primary);
    }

    .leaderboard-score {
      font-weight: bold;
      color: var(--text-primary);
    }

    @media (max-width: 768px) {
      .game-modes {
        grid-template-columns: 1fr;
      }

      .game-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      #gameCanvas {
        max-width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body class="dark-theme">
  <header class="header-dark">
    <div class="header-container">
      <div class="logo"><h1>üöó ENHANCED CROSSY ROAD</h1></div>
      <div id="authSection" class="auth-buttons"></div>
    </div>
  </header>

  <main class="container-dark">
    <div class="game-wrapper">
      <div class="game-header">
        <h1 class="game-title">Enhanced Crossy Road Multiplayer</h1>
        <p style="color: var(--text-secondary);">Dodge traffic and compete for high scores!</p>
      </div>

      <!-- Game Mode Selection -->
      <div id="modeSelection" class="game-modes">
        <div class="mode-card">
          <span class="mode-icon">üéÆ</span>
          <div class="mode-title">Classic Mode</div>
          <div class="mode-description">Traditional crossy road gameplay with enhanced graphics</div>
          <button class="mode-btn" onclick="startClassicMode()">Play Classic</button>
        </div>

        <div class="mode-card">
          <span class="mode-icon">‚ö°</span>
          <div class="mode-title">Speed Run</div>
          <div class="mode-description">Race against time to reach the highest distance</div>
          <button class="mode-btn" onclick="startSpeedRun()">Speed Run</button>
        </div>

        <div class="mode-card">
          <span class="mode-icon">üë•</span>
          <div class="mode-title">Multiplayer Battle</div>
          <div class="mode-description">Compete against other players in real-time</div>
          <button class="mode-btn" onclick="startMultiplayer()">Find Match</button>
        </div>

        <div class="mode-card">
          <span class="mode-icon">üèÜ</span>
          <div class="mode-title">Endless Mode</div>
          <div class="mode-description">Test your skills in infinite gameplay</div>
          <button class="mode-btn" onclick="startEndless()">Endless Mode</button>
        </div>
      </div>

      <!-- Game Area -->
      <div id="gameArea" class="game-area">
        <div class="game-stats">
          <div class="stat-card">
            <div class="stat-label">üí∞ Coins</div>
            <div class="stat-value" id="coinDisplay">1000</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">üíµ Current Bet</div>
            <div class="stat-value" id="betDisplay">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">üìä Distance</div>
            <div class="stat-value" id="distanceDisplay">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">‚è±Ô∏è Time</div>
            <div class="stat-value" id="timeDisplay">0:00</div>
          </div>
        </div>

        <!-- Multiplayer Section -->
        <div id="multiplayerSection" class="multiplayer-section">
          <div class="opponent-info">
            <div class="player-card">
              <div class="player-name">You</div>
              <div class="player-distance" id="playerDistance">0m</div>
            </div>
            <div class="vs-text">VS</div>
            <div class="player-card">
              <div class="player-name" id="opponentName">Waiting...</div>
              <div class="player-distance" id="opponentDistance">0m</div>
            </div>
          </div>
        </div>

        <!-- Betting Section -->
        <div id="bettingSection" class="betting-section">
          <div class="betting-title">üí∞ Place Your Bet (Higher = Better Rewards!)</div>
          <div class="bet-amount">
            <button class="amount-btn active" onclick="setBet(50)">50</button>
            <button class="amount-btn" onclick="setBet(100)">100</button>
            <button class="amount-btn" onclick="setBet(250)">250</button>
            <button class="amount-btn" onclick="setBet(500)">500</button>
          </div>
          <div class="custom-bet">
            <input type="number" id="customBetAmount" class="bet-input" min="10" max="1000" value="50" />
            <button class="control-btn btn-primary" onclick="startGame()">Start Game</button>
          </div>
        </div>

        <!-- Instructions -->
        <div class="instructions">
          <h3>üéÆ How to Play</h3>
          <p>Use arrow keys or A/D to move left/right and dodge traffic!</p>
          <p>The further you go, the higher your multiplier and rewards!</p>
          <div class="control-keys">
            <div class="key">‚Üê A</div>
            <div class="key">‚Üí D</div>
            <div class="key">‚Üë W</div>
            <div class="key">‚Üì S</div>
          </div>
        </div>

        <!-- Game Canvas -->
        <div class="game-canvas-container">
          <canvas id="gameCanvas" width="400" height="600"></canvas>
        </div>

        <!-- Game Status -->
        <div class="game-status" id="gameStatus">Ready to play!</div>
        <div id="resultMessage" class="result-message"></div>

        <!-- Controls -->
        <div class="game-controls">
          <button id="pauseBtn" class="control-btn btn-secondary" onclick="togglePause()" style="display: none;">Pause</button>
          <button id="resetBtn" class="control-btn btn-primary" onclick="resetGame()" style="display: none;">Play Again</button>
          <button class="control-btn btn-secondary" onclick="backToMenu()">Menu</button>
        </div>
      </div>

      <!-- Leaderboard -->
      <div id="leaderboard" class="leaderboard" style="display: none;">
        <div class="leaderboard-title">üèÜ High Scores</div>
        <ul class="leaderboard-list" id="leaderboardList"></ul>
      </div>
    </div>
  </main>

  <div id="authModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <div id="notificationContainer" class="notification-container"></div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="/js/main.js"></script>
  <script>
    // Enhanced Game State
    let gameState = {
      mode: null,
      canvas: null,
      ctx: null,
      gridSize: 40,
      player: { x: 4, y: 14 },
      cars: [],
      distance: 0,
      timeElapsed: 0,
      gameActive: false,
      isPaused: false,
      currentBet: 0,
      keys: {},
      timer: null,
      animationId: null,
      multiplayer: {
        roomId: null,
        opponent: null,
        opponentDistance: 0
      },
      highScore: localStorage.getItem('crossyroadHighScore') || 0
    };

    // Socket is already declared in main.js, just make sure it's initialized
    if (!socket) {
      socket = io();
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      gameState.canvas = document.getElementById('gameCanvas');
      gameState.ctx = gameState.canvas.getContext('2d');
      updateAuthUI();
      setupSocketListeners();
      setupEventListeners();
      initializeCanvas();
    });

    function setupSocketListeners() {
      socket.on('match-found', (data) => {
        console.log('Crossy Road match found:', data);
        gameState.mode = 'multiplayer';
        gameState.multiplayer.roomId = data.roomId;
        gameState.multiplayer.opponent = data.opponent;
        
        document.getElementById('modeSelection').style.display = 'none';
        document.getElementById('gameArea').style.display = 'block';
        document.getElementById('multiplayerSection').style.display = 'block';
        document.getElementById('opponentName').textContent = data.opponent.username;
        
        showNotification('üéÆ Opponent found! Get ready to race!', 'success');
      });

      socket.on('game-action', (data) => {
        handleMultiplayerAction(data);
      });

      socket.on('error', (data) => {
        showNotification(data.message || 'An error occurred', 'error');
      });
    }

    function setupEventListeners() {
      document.addEventListener('keydown', (e) => {
        gameState.keys[e.key] = true;
        handleInput(e.key);
      });

      document.addEventListener('keyup', (e) => {
        gameState.keys[e.key] = false;
      });
    }

    function handleInput(key) {
      if (!gameState.gameActive || gameState.isPaused) return;

      if ((key === 'ArrowLeft' || key === 'a' || key === 'A') && gameState.player.x > 0) {
        gameState.player.x--;
      }
      if ((key === 'ArrowRight' || key === 'd' || key === 'D') && gameState.player.x < 9) {
        gameState.player.x++;
      }
      if ((key === 'ArrowUp' || key === 'w' || key === 'W') && gameState.player.y > 0) {
        gameState.player.y--;
      }
      if ((key === 'ArrowDown' || key === 's' || key === 'S') && gameState.player.y < 14) {
        gameState.player.y++;
      }
    }

    function updateAuthUI() {
      document.getElementById('authSection').innerHTML = currentUser
        ? `<div class="user-info"><span>üë§ ${currentUser.username}</span><span class="coins">üí∞ ${userCoins}</span></div>`
        : '<button onclick="showLoginModal()" class="btn">Login</button>';
    }

    function startClassicMode() {
      gameState.mode = 'classic';
      document.getElementById('modeSelection').style.display = 'none';
      document.getElementById('gameArea').style.display = 'block';
      document.getElementById('multiplayerSection').style.display = 'none';
      document.getElementById('bettingSection').style.display = 'block';
      document.getElementById('leaderboard').style.display = 'block';
      
      loadLeaderboard();
    }

    function startSpeedRun() {
      gameState.mode = 'speedrun';
      document.getElementById('modeSelection').style.display = 'none';
      document.getElementById('gameArea').style.display = 'block';
      document.getElementById('multiplayerSection').style.display = 'none';
      document.getElementById('bettingSection').style.display = 'block';
      document.getElementById('leaderboard').style.display = 'block';
      
      loadLeaderboard();
    }

    function startMultiplayer() {
      if (!currentUser) {
        showNotification('Please login to play multiplayer', 'error');
        showLoginModal();
        return;
      }

      socket.emit('find-match', {
        gameType: 'crossyroad',
        playerData: {
          userId: currentUser.id,
          username: currentUser.username,
          coins: userCoins
        }
      });
    }

    function startEndless() {
      gameState.mode = 'endless';
      document.getElementById('modeSelection').style.display = 'none';
      document.getElementById('gameArea').style.display = 'block';
      document.getElementById('multiplayerSection').style.display = 'none';
      document.getElementById('bettingSection').style.display = 'block';
      document.getElementById('leaderboard').style.display = 'block';
      
      loadLeaderboard();
    }

    function setBet(amount) {
      document.getElementById('customBetAmount').value = amount;
      document.querySelectorAll('.amount-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    function startGame() {
      const bet = parseInt(document.getElementById('customBetAmount').value);

      if (bet < 10) {
        showNotification('Minimum bet is 10 coins', 'error');
        return;
      }

      if (bet > userCoins) {
        showNotification('Not enough coins', 'error');
        return;
      }

      gameState.currentBet = bet;
      updateCoins(-bet, 'crossyroad', 'bet');

      document.getElementById('betDisplay').textContent = bet;
      document.getElementById('bettingSection').style.display = 'none';
      document.getElementById('pauseBtn').style.display = 'inline-block';

      initializeGame();
      startTimer();
      gameLoop();
    }

    function initializeGame() {
      gameState.player = { x: 4, y: 14 };
      gameState.cars = [];
      gameState.distance = 0;
      gameState.timeElapsed = 0;
      gameState.gameActive = true;
      gameState.isPaused = false;

      updateDisplay();
      updateStatus('üéÆ Game Started!', 'playing');
    }

    function initializeCanvas() {
      gameState.ctx.fillStyle = '#87ceeb';
      gameState.ctx.fillRect(0, 0, gameState.canvas.width, gameState.canvas.height);
    }

    function startTimer() {
      gameState.timer = setInterval(() => {
        if (!gameState.isPaused && gameState.gameActive) {
          gameState.timeElapsed++;
          updateTimer();
        }
      }, 1000);
    }

    function updateTimer() {
      const minutes = Math.floor(gameState.timeElapsed / 60);
      const seconds = gameState.timeElapsed % 60;
      document.getElementById('timeDisplay').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function gameLoop() {
      if (!gameState.gameActive) return;

      update();
      draw();
      gameState.animationId = requestAnimationFrame(gameLoop);
    }

    function update() {
      if (gameState.isPaused) return;

      // Spawn cars based on difficulty
      const spawnRate = gameState.mode === 'speedrun' ? 0.03 : 
                       gameState.mode === 'endless' ? 0.01 : 0.02;
      
      if (Math.random() < spawnRate) {
        const lane = Math.floor(Math.random() * 12);
        const direction = Math.random() < 0.5 ? 1 : -1;
        gameState.cars.push(new Car(lane, direction));
      }

      // Update cars
      gameState.cars = gameState.cars.filter(car => !car.isOffscreen());
      gameState.cars.forEach(car => car.update());

      // Check collisions
      gameState.cars.forEach(car => {
        if (checkCollision(gameState.player, car)) {
          endGame();
        }
      });

      // Update distance
      if (gameState.mode !== 'endless' && gameState.distance % 50 === 0 && gameState.distance > 0) {
        gameState.player.y--;
        if (gameState.player.y < 0) {
          gameState.player.y = 0;
        }
      }

      gameState.distance++;
      document.getElementById('distanceDisplay').textContent = Math.floor(gameState.distance / 10);

      // Send update to server in multiplayer
      if (gameState.mode === 'multiplayer' && gameState.multiplayer.roomId) {
        socket.emit('game-action', {
          action: 'update',
          roomId: gameState.multiplayer.roomId,
          distance: Math.floor(gameState.distance / 10)
        });
      }
    }

    function checkCollision(player, car) {
      return player.y === car.lane &&
             player.x * gameState.gridSize < (car.x + car.width) * gameState.gridSize &&
             (player.x + 1) * gameState.gridSize > car.x * gameState.gridSize;
    }

    function draw() {
      const ctx = gameState.ctx;
      const canvas = gameState.canvas;
      const gridSize = gameState.gridSize;

      // Sky gradient
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#87ceeb');
      gradient.addColorStop(1, '#6bb6d6');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Ground tiles
      for (let i = 0; i < 15; i++) {
        ctx.fillStyle = i % 2 === 0 ? '#90ee90' : '#7cb342';
        ctx.fillRect(0, i * gridSize, canvas.width, gridSize);
        ctx.strokeStyle = '#666';
        ctx.lineWidth = 1;
        ctx.strokeRect(0, i * gridSize, canvas.width, gridSize);
      }

      // Road with lanes
      for (let i = 4; i < 12; i++) {
        ctx.fillStyle = '#333';
        ctx.fillRect(0, i * gridSize, canvas.width, gridSize);

        ctx.strokeStyle = '#fbbf24';
        ctx.lineWidth = 2;
        ctx.setLineDash([10, 10]);
        ctx.beginPath();
        ctx.moveTo(0, (i + 0.5) * gridSize);
        ctx.lineTo(canvas.width, (i + 0.5) * gridSize);
        ctx.stroke();
        ctx.setLineDash([]);
      }

      // Draw cars
      gameState.cars.forEach(car => car.draw());

      // Draw player (chicken character)
      ctx.fillStyle = '#fbbf24';
      ctx.fillRect(
        gameState.player.x * gridSize + 5,
        gameState.player.y * gridSize + 5,
        gridSize - 10,
        gridSize - 10
      );

      // Player details (eyes and beak)
      ctx.fillStyle = '#000';
      ctx.fillRect(gameState.player.x * gridSize + 10, gameState.player.y * gridSize + 10, 5, 5);
      ctx.fillRect(gameState.player.x * gridSize + 25, gameState.player.y * gridSize + 10, 5, 5);
      
      // Beak
      ctx.fillStyle = '#ff6b35';
      ctx.fillRect(gameState.player.x * gridSize + 17, gameState.player.y * gridSize + 20, 6, 3);
    }

    function endGame() {
      gameState.gameActive = false;
      clearInterval(gameState.timer);
      cancelAnimationFrame(gameState.animationId);

      const distTraveled = Math.floor(gameState.distance / 10);
      const multiplier = Math.max(1, Math.floor(distTraveled / 10));
      const winnings = gameState.currentBet * multiplier;
      const profit = winnings - gameState.currentBet;

      updateStatus('üéÆ Game Over!', 'gameover');
      
      const resultMsg = document.getElementById('resultMessage');
      resultMsg.innerHTML = `
        <div>üéÆ Game Over!</div>
        <div>Distance: ${distTraveled}m</div>
        <div>Multiplier: ${multiplier}x</div>
        <div>üéâ You earned ${winnings} coins! (+${profit})</div>
      `;
      resultMsg.className = 'result-message result-win';

      updateCoins(winnings, 'crossyroad', 'win');
      updateDisplay();

      document.getElementById('resetBtn').style.display = 'inline-block';
      document.getElementById('pauseBtn').style.display = 'none';

      // Update high score
      if (distTraveled > gameState.highScore) {
        gameState.highScore = distTraveled;
        localStorage.setItem('crossyroadHighScore', gameState.highScore);
        showNotification(`üèÜ New high score: ${distTraveled}m!`, 'success');
      }

      // Send result to server in multiplayer
      if (gameState.mode === 'multiplayer' && gameState.multiplayer.roomId) {
        socket.emit('game-action', {
          action: 'game-over',
          roomId: gameState.multiplayer.roomId,
          distance: distTraveled
        });
      }
    }

    function togglePause() {
      gameState.isPaused = !gameState.isPaused;
      const pauseBtn = document.getElementById('pauseBtn');
      pauseBtn.textContent = gameState.isPaused ? 'Resume' : 'Pause';
      
      if (gameState.isPaused) {
        updateStatus('‚è∏Ô∏è Game Paused', 'playing');
      } else {
        updateStatus('üéÆ Playing...', 'playing');
      }
    }

    function resetGame() {
      document.getElementById('bettingSection').style.display = 'block';
      document.getElementById('resetBtn').style.display = 'none';
      document.getElementById('pauseBtn').style.display = 'none';
      document.getElementById('resultMessage').innerHTML = '';
      document.getElementById('resultMessage').className = 'result-message';
      
      initializeCanvas();
    }

    function backToMenu() {
      gameState.gameActive = false;
      clearInterval(gameState.timer);
      cancelAnimationFrame(gameState.animationId);
      
      document.getElementById('modeSelection').style.display = 'grid';
      document.getElementById('gameArea').style.display = 'none';
      document.getElementById('multiplayerSection').style.display = 'none';
      document.getElementById('leaderboard').style.display = 'none';
      
      // Leave multiplayer room if in one
      if (gameState.mode === 'multiplayer' && gameState.multiplayer.roomId) {
        socket.emit('leave-room', {
          roomId: gameState.multiplayer.roomId
        });
      }
    }

    function updateDisplay() {
      document.getElementById('coinDisplay').textContent = userCoins;
      document.getElementById('distanceDisplay').textContent = Math.floor(gameState.distance / 10);
    }

    function updateStatus(text, status) {
      const statusEl = document.getElementById('gameStatus');
      statusEl.textContent = text;
      statusEl.className = `game-status status-${status}`;
    }

    function handleMultiplayerAction(data) {
      console.log('Multiplayer action received:', data);
      // Handle multiplayer game actions
    }

    function loadLeaderboard() {
      // Load leaderboard from server or local storage
      const leaderboard = [
        { name: 'Player1', score: 150 },
        { name: 'Player2', score: 120 },
        { name: 'Player3', score: 80 }
      ];
      
      updateLeaderboard(leaderboard);
    }

    function updateLeaderboard(leaderboard) {
      const list = document.getElementById('leaderboardList');
      list.innerHTML = leaderboard.map((entry, index) => `
        <li class="leaderboard-item">
          <span class="leaderboard-rank">#${index + 1}</span>
          <span class="leaderboard-name">${entry.name}</span>
          <span class="leaderboard-score">${entry.score}m</span>
        </li>
      `).join('');
    }

    // Car class
    class Car {
      constructor(lane, direction) {
        this.lane = lane;
        this.direction = direction;
        this.x = direction > 0 ? -1 : 10;
        this.width = 1.5;
        this.color = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b'][Math.floor(Math.random() * 4)];
      }

      update() {
        this.x += this.direction * 0.15;
      }

      draw() {
        const ctx = gameState.ctx;
        const gridSize = gameState.gridSize;
        
        ctx.fillStyle = this.color;
        ctx.fillRect(
          this.x * gridSize,
          this.lane * gridSize,
          this.width * gridSize,
          gridSize - 5
        );
        
        // Car windows
        ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.fillRect(
          this.x * gridSize + 5,
          this.lane * gridSize + 5,
          this.width * gridSize - 10,
          gridSize - 15
        );
      }

      isOffscreen() {
        return this.x > 11 || this.x < -2;
      }
    }
  </script>
</body>
</html>
