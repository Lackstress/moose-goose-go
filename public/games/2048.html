<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2048</title>
  <link rel="stylesheet" href="/styles.css">
  <style>
    .game-board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      background: #bbada0;
      padding: 12px;
      border-radius: 8px;
      width: 100%;
      max-width: 350px;
      margin: 2rem auto;
      aspect-ratio: 1;
    }

    .tile {
      background: #cdc1b4;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
      color: #776e65;
      position: relative;
      animation: popIn 0.1s ease-out;
    }

    @keyframes popIn {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .tile.merged {
      animation: merge 0.15s ease-out;
    }

    @keyframes merge {
      0% { transform: scale(0.8); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    /* Tile colors */
    .tile-2 { background: #eee4da; color: #776e65; }
    .tile-4 { background: #ede0c8; color: #776e65; }
    .tile-8 { background: #f2b179; color: #f9f6f2; }
    .tile-16 { background: #f59563; color: #f9f6f2; }
    .tile-32 { background: #f67c5f; color: #f9f6f2; }
    .tile-64 { background: #f65e3b; color: #f9f6f2; }
    .tile-128 { background: #edcf72; color: #095f6b; font-size: 1.8rem; }
    .tile-256 { background: #edcc61; color: #095f6b; font-size: 1.8rem; }
    .tile-512 { background: #edc850; color: #095f6b; font-size: 1.8rem; }
    .tile-1024 { background: #edc53f; color: #095f6b; font-size: 1.5rem; }
    .tile-2048 { background: #edc22e; color: #095f6b; font-size: 1.5rem; }

    .game-info {
      display: flex;
      justify-content: space-around;
      background: rgba(255, 255, 255, 0.9);
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .info-item {
      text-align: center;
    }

    .info-label {
      font-size: 0.9rem;
      color: #666;
      font-weight: 600;
    }

    .info-value {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
    }

    .game-controls {
      text-align: center;
      margin: 2rem 0;
      padding: 2rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 12px;
    }

    .game-status {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 1rem;
      min-height: 2rem;
    }

    .status-playing { color: #667eea; }
    .status-gameover { color: #ef4444; }
    .status-win { color: #10b981; }

    .instruction {
      font-size: 1rem;
      color: #666;
      margin: 1rem 0;
    }

    .movement-guide {
      font-size: 0.9rem;
      color: #999;
      margin-top: 1rem;
      line-height: 1.8;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <div class="logo"><h1>2Ô∏è‚É£0Ô∏è‚É£4Ô∏è‚É£8Ô∏è‚É£</h1></div>
      <div id="authSection" class="auth-buttons"></div>
    </div>
  </header>

  <main class="container">
    <div class="game-container">
      <div class="game-header">
        <h1>2048 - Combine Numbers!</h1>
        <a href="/" class="btn">Back to Lobby</a>
      </div>

      <div class="game-info">
        <div class="info-item">
          <div class="info-label">üí∞ Coins</div>
          <div class="info-value" id="coinDisplay">1000</div>
        </div>
        <div class="info-item">
          <div class="info-label">üìä Score</div>
          <div class="info-value" id="scoreDisplay">0</div>
        </div>
        <div class="info-item">
          <div class="info-label">üèÜ Best</div>
          <div class="info-value" id="bestScoreDisplay">0</div>
        </div>
      </div>

      <div class="game-board" id="gameBoard"></div>

      <div class="game-controls">
        <div class="game-status" id="gameStatus">Ready to play!</div>
        <div class="instruction" id="instruction">Use arrow keys or swipe to move tiles</div>
        
        <button onclick="newGame()" class="btn" id="newGameBtn">NEW GAME</button>
        <button onclick="undo()" class="btn secondary" id="undoBtn" style="display: none;">UNDO</button>
        
        <div class="movement-guide">
          <strong>Controls:</strong><br>
          ‚¨ÜÔ∏è ‚¨áÔ∏è ‚¨ÖÔ∏è ‚û°Ô∏è Arrow keys to move<br>
          W A S D keys also work
        </div>
      </div>
    </div>
  </main>

  <div id="authModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <div id="notificationContainer" class="notification-container"></div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="/js/main.js"></script>
  <script>
    let grid = [];
    let score = 0;
    let bestScore = localStorage.getItem('best2048Score') || 0;
    let gameOver = false;
    let won = false;
    let history = [];

    function updateAuthUI() {
      document.getElementById('authSection').innerHTML = currentUser
        ? `<div class="user-info"><span>üë§ ${currentUser.username}</span><span class="coins">üí∞ ${userCoins}</span></div>`
        : '<button onclick="showLoginModal()" class="btn">Login</button>';
    }

    function initGrid() {
      grid = Array(4).fill(null).map(() => Array(4).fill(0));
      addNewTile();
      addNewTile();
    }

    function addNewTile() {
      let empty = [];
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (grid[i][j] === 0) empty.push([i, j]);
        }
      }
      if (empty.length > 0) {
        let [i, j] = empty[Math.floor(Math.random() * empty.length)];
        grid[i][j] = Math.random() < 0.9 ? 2 : 4;
      }
    }

    function render() {
      const board = document.getElementById('gameBoard');
      board.innerHTML = '';
      
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          const tile = document.createElement('div');
          const value = grid[i][j];
          
          tile.className = `tile ${value > 0 ? `tile-${value}` : ''}`;
          tile.textContent = value > 0 ? value : '';
          board.appendChild(tile);
        }
      }

      document.getElementById('scoreDisplay').textContent = score;
      document.getElementById('bestScoreDisplay').textContent = bestScore;
      document.getElementById('coinDisplay').textContent = userCoins;
    }

    function move(direction) {
      if (gameOver) return;

      history.push({
        grid: JSON.parse(JSON.stringify(grid)),
        score: score
      });

      let moved = false;
      let merged = false;

      if (direction === 'left' || direction === 'right') {
        for (let i = 0; i < 4; i++) {
          if (direction === 'right') grid[i].reverse();
          let row = grid[i].filter(v => v !== 0);
          
          for (let j = 0; j < row.length - 1; j++) {
            if (row[j] === row[j + 1]) {
              row[j] *= 2;
              score += row[j];
              row.splice(j + 1, 1);
              merged = true;
            }
          }
          
          while (row.length < 4) row.push(0);
          if (direction === 'right') row.reverse();
          
          grid[i] = row;
          moved = true;
        }
      } else {
        // Transpose
        for (let i = 0; i < 4; i++) {
          for (let j = i + 1; j < 4; j++) {
            [grid[i][j], grid[j][i]] = [grid[j][i], grid[i][j]];
          }
        }

        for (let i = 0; i < 4; i++) {
          if (direction === 'down') grid[i].reverse();
          let column = grid[i].filter(v => v !== 0);
          
          for (let j = 0; j < column.length - 1; j++) {
            if (column[j] === column[j + 1]) {
              column[j] *= 2;
              score += column[j];
              column.splice(j + 1, 1);
              merged = true;
            }
          }
          
          while (column.length < 4) column.push(0);
          if (direction === 'down') column.reverse();
          
          grid[i] = column;
          moved = true;
        }

        // Transpose back
        for (let i = 0; i < 4; i++) {
          for (let j = i + 1; j < 4; j++) {
            [grid[i][j], grid[j][i]] = [grid[j][i], grid[i][j]];
          }
        }
      }

      if (moved) {
        addNewTile();
        render();

        if (merged) {
          const reward = Math.floor(score / 10);
          updateCoins(reward, '2048', 'win');
        }

        if (hasWon()) {
          won = true;
          document.getElementById('gameStatus').textContent = 'üéâ You reached 2048! Keep playing!';
          document.getElementById('gameStatus').className = 'game-status status-win';
        }

        if (isGameOver()) {
          gameOver = true;
          document.getElementById('gameStatus').textContent = 'Game Over! Start a new game.';
          document.getElementById('gameStatus').className = 'game-status status-gameover';
          
          if (score > bestScore) {
            bestScore = score;
            localStorage.setItem('best2048Score', bestScore);
            updateCoins(Math.floor(score / 5), '2048', 'bonus');
            showNotification(`New best score! +${Math.floor(score / 5)} bonus coins! üèÜ`, 'success');
          }
        }
      } else {
        history.pop();
      }
    }

    function hasWon() {
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (grid[i][j] === 2048) return true;
        }
      }
      return false;
    }

    function isGameOver() {
      // Check if there are empty tiles
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          if (grid[i][j] === 0) return false;
        }
      }

      // Check if any moves are possible
      for (let i = 0; i < 4; i++) {
        for (let j = 0; j < 4; j++) {
          const current = grid[i][j];
          if ((j < 3 && current === grid[i][j + 1]) || (i < 3 && current === grid[i + 1][j])) {
            return false;
          }
        }
      }

      return true;
    }

    function undo() {
      if (history.length > 0) {
        const prev = history.pop();
        grid = prev.grid;
        score = prev.score;
        gameOver = false;
        won = false;
        document.getElementById('gameStatus').textContent = 'üéÆ Playing...';
        document.getElementById('gameStatus').className = 'game-status status-playing';
        render();
      }
    }

    function newGame() {
      score = 0;
      gameOver = false;
      won = false;
      history = [];
      initGrid();
      document.getElementById('gameStatus').textContent = 'üéÆ Playing...';
      document.getElementById('gameStatus').className = 'game-status status-playing';
      document.getElementById('undoBtn').style.display = 'inline-block';
      render();
    }

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
      const keyMap = {
        'ArrowUp': 'up', 'w': 'up', 'W': 'up',
        'ArrowDown': 'down', 's': 'down', 'S': 'down',
        'ArrowLeft': 'left', 'a': 'left', 'A': 'left',
        'ArrowRight': 'right', 'd': 'right', 'D': 'right'
      };

      if (keyMap[e.key]) {
        e.preventDefault();
        move(keyMap[e.key]);
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      updateAuthUI();
      document.getElementById('bestScoreDisplay').textContent = bestScore;
      document.getElementById('coinDisplay').textContent = userCoins;
      initGrid();
      render();
      document.getElementById('undoBtn').style.display = 'inline-block';
    });
  </script>
</body>
</html>
