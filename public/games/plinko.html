<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Plinko - Professional Casino</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="/js/main.js"></script>
  <link rel="stylesheet" href="/styles.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1a1a1a;
      color: #fff;
      overflow-x: hidden;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: 100%;
      margin: 0 auto;
      padding: 15px;
      display: grid;
      grid-template-columns: minmax(250px, 280px) 1fr minmax(250px, 280px);
      gap: 15px;
      flex: 1;
      overflow: hidden;
    }

    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 1fr;
        height: auto;
        flex: 1;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
        gap: 10px;
      }
    }

    /* Left Panel - Betting Controls */
    .left-panel {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 15px;
      height: fit-content;
      overflow-y: auto;
      max-height: 100vh;
    }

    @media (max-width: 1200px) {
      .left-panel {
        max-height: none;
      }
    }

    @media (max-width: 768px) {
      .left-panel {
        padding: 10px;
      }
    }

    .balance {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .balance h2 {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 5px;
    }

    .balance .amount {
      font-size: 28px;
      font-weight: bold;
    }

    .bet-input {
      background: #1a1a1a;
      border: 2px solid #3a3a3a;
      border-radius: 8px;
      padding: 15px;
      color: #fff;
      width: 100%;
      font-size: 18px;
      margin-bottom: 15px;
    }

    .multiplier-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }

    .multiplier-btn {
      background: #3a3a3a;
      border: none;
      padding: 12px;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .multiplier-btn:hover {
      background: #4a4a4a;
      transform: translateY(-2px);
    }

    .multiplier-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .risk-selector {
      margin-bottom: 20px;
    }

    .risk-selector h3 {
      font-size: 14px;
      margin-bottom: 10px;
      opacity: 0.8;
    }

    .risk-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .risk-btn {
      background: #3a3a3a;
      border: none;
      padding: 10px;
      border-radius: 6px;
      color: #fff;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .risk-btn.low.active {
      background: #22c55e;
    }

    .risk-btn.medium.active {
      background: #f59e0b;
    }

    .risk-btn.high.active {
      background: #ef4444;
    }

    .bet-button {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 10px;
    }

    .bet-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(34, 197, 94, 0.4);
    }

    .bet-button:active {
      transform: translateY(0);
    }

    .bet-button:disabled {
      background: #3a3a3a;
      cursor: not-allowed;
      opacity: 0.5;
    }

    /* Center - Game Board */
    .game-board {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 15px;
      position: relative;
      display: flex;
      flex-direction: column;
      min-height: 500px;
      overflow: hidden;
    }

    @media (max-width: 1200px) {
      .game-board {
        min-height: 600px;
        order: -1;
      }
    }

    @media (max-width: 768px) {
      .game-board {
        min-height: 400px;
        padding: 10px;
      }
    }

    .stats-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      padding: 15px;
      background: #1a1a1a;
      border-radius: 8px;
    }

    .stat {
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      opacity: 0.6;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: bold;
    }

    .stat-value.green {
      color: #22c55e;
    }

    canvas {
      border-radius: 8px;
      background: #1a1a1a;
      display: block;
      margin: 0 auto;
      width: 100%;
      height: auto;
      max-width: 100%;
      aspect-ratio: 4 / 3;
    }

    @media (max-width: 768px) {
      canvas {
        aspect-ratio: 3 / 4;
      }
    }

    /* Right Panel - History */
    .right-panel {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 15px;
      height: fit-content;
      max-height: 100vh;
      overflow-y: auto;
    }

    @media (max-width: 1200px) {
      .right-panel {
        max-height: 400px;
      }
    }

    @media (max-width: 768px) {
      .right-panel {
        max-height: 300px;
        padding: 10px;
      }
    }

    .right-panel h2 {
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .history-item {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .history-multiplier {
      font-size: 16px;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 4px;
    }

    .history-multiplier.win {
      background: #22c55e;
      color: #fff;
    }

    .history-multiplier.loss {
      background: #ef4444;
      color: #fff;
    }

    .history-amount {
      font-size: 14px;
    }

    .history-amount.profit {
      color: #22c55e;
    }

    .history-amount.loss {
      color: #ef4444;
    }

    /* Multiplier Display */
    .multipliers {
      display: flex;
      justify-content: space-around;
      margin-top: 10px;
      padding: 10px;
      background: #1a1a1a;
      border-radius: 8px;
      font-size: 12px;
      font-weight: bold;
    }

    .multiplier-box {
      padding: 8px 12px;
      border-radius: 4px;
      min-width: 50px;
      text-align: center;
    }

    .multiplier-1000x { background: #ef4444; }
    .multiplier-130x { background: #f97316; }
    .multiplier-26x { background: #f59e0b; }
    .multiplier-9x { background: #eab308; }
    .multiplier-4x { background: #84cc16; }
    .multiplier-2x { background: #22c55e; }
    .multiplier-0-2x { background: #f97316; }

    /* Scrollbar */
    .right-panel::-webkit-scrollbar {
      width: 8px;
    }

    .right-panel::-webkit-scrollbar-track {
      background: #1a1a1a;
      border-radius: 4px;
    }

    .right-panel::-webkit-scrollbar-thumb {
      background: #4a4a4a;
      border-radius: 4px;
    }

    .right-panel::-webkit-scrollbar-thumb:hover {
      background: #5a5a5a;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 1fr;
      }

      .left-panel, .right-panel {
        max-width: 600px;
        margin: 0 auto;
      }
    }

    .max-win {
      text-align: center;
      margin-top: 15px;
      padding: 15px;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      border-radius: 8px;
      font-size: 24px;
      font-weight: bold;
    }

    .max-win-label {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 5px;
    }

    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #2a2a2a;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      z-index: 1000;
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: #3a3a3a;
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="window.location.href='/ghub'">‚Üê Back to GameHub</button>

  <div class="container">
    <!-- Left Panel - Betting Controls -->
    <div class="left-panel">
      <div class="balance">
        <h2>Balance ‚Çø</h2>
        <div class="amount" id="balance">1000</div>
      </div>

      <input type="number" class="bet-input" id="betAmount" value="100" min="10" max="5000" placeholder="Bet Amount">

      <div class="multiplier-buttons">
        <button class="multiplier-btn" onclick="multiplyBet(0.5)">1/2</button>
        <button class="multiplier-btn active" onclick="multiplyBet(2)">2x</button>
        <button class="multiplier-btn" onclick="allIn()">ALL IN</button>
        <button class="multiplier-btn" onclick="placeBet()">BET</button>
      </div>

      <button class="bet-button" id="dropButton" onclick="dropBall()">üé≤ DROP BALL</button>
      <button class="bet-button" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);" onclick="resetGame()">üîÑ Reset Game</button>

      <div class="max-win">
        <div class="max-win-label">Max Win:</div>
        ‚Çø<span id="maxWin">100000</span>
      </div>
    </div>

    <!-- Center - Game Board -->
    <div class="game-board">
      <div class="stats-bar">
        <div class="stat">
          <div class="stat-label">Total Wagered</div>
          <div class="stat-value">‚Çø<span id="totalWagered">0</span></div>
        </div>
        <div class="stat">
          <div class="stat-label">Total Won</div>
          <div class="stat-value green">‚Çø<span id="totalWon">0</span></div>
        </div>
        <div class="stat">
          <div class="stat-label">Balls Dropped</div>
          <div class="stat-value"><span id="ballsDropped">0</span></div>
        </div>
      </div>

      <canvas id="plinkoCanvas" width="800" height="600"></canvas>

      <div class="multipliers">
        <div class="multiplier-box multiplier-1000x">1000x</div>
        <div class="multiplier-box multiplier-130x">130x</div>
        <div class="multiplier-box multiplier-26x">26x</div>
        <div class="multiplier-box multiplier-9x">9x</div>
        <div class="multiplier-box multiplier-4x">4x</div>
        <div class="multiplier-box multiplier-2x">2x</div>
        <div class="multiplier-box multiplier-0-2x">0.2x</div>
        <div class="multiplier-box multiplier-0-2x">0.2x</div>
        <div class="multiplier-box multiplier-0-2x">0.2x</div>
        <div class="multiplier-box multiplier-0-2x">0.2x</div>
        <div class="multiplier-box multiplier-0-2x">0.2x</div>
        <div class="multiplier-box multiplier-2x">2x</div>
        <div class="multiplier-box multiplier-4x">4x</div>
        <div class="multiplier-box multiplier-9x">9x</div>
        <div class="multiplier-box multiplier-26x">26x</div>
        <div class="multiplier-box multiplier-130x">130x</div>
        <div class="multiplier-box multiplier-1000x">1000x</div>
      </div>
    </div>

    <!-- Right Panel - History -->
    <div class="right-panel">
      <h2>
        <span>üìä</span>
        Recent Drops
      </h2>
      <div id="history">
        <!-- History items will be added dynamically -->
      </div>
    </div>
  </div>

  <script>
    // Game State
    let balance = 1000;
    let currentBet = 100;
    let totalWagered = 0;
    let totalWon = 0;
    let ballsDropped = 0;

    // Canvas setup
    const canvas = document.getElementById('plinkoCanvas');
    const ctx = canvas.getContext('2d');

    // Fixed hard multipliers (removed risk selection)
    const multipliers = [1000, 130, 26, 9, 4, 2, 0.2, 0.2, 0.2, 0.2, 0.2, 2, 4, 9, 26, 130, 1000];

    // Plinko board configuration - INCREASED ROWS FOR MORE DIFFICULTY
    const rows = 20; // increased from 16 to 20 for more challenge
    const pegRadius = 5;
    const ballRadius = 10;
    const spacing = 45;
    const startX = 300;
    const startY = 50;

    // Initialize
    function init() {
      drawBoard();
      updateUI();
    }

    // Draw the plinko board
    function drawBoard() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // Draw pegs
      ctx.fillStyle = '#4a4a4a';
      for (let row = 0; row < rows; row++) {
        const pegsInRow = row + 3;
        const rowY = startY + row * spacing;
        const rowStartX = startX - (pegsInRow - 1) * spacing / 2;
        
        for (let col = 0; col < pegsInRow; col++) {
          const pegX = rowStartX + col * spacing;
          ctx.beginPath();
          ctx.arc(pegX, rowY, pegRadius, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      // Draw buckets
      const bucketWidth = canvas.width / 17;
      const bucketY = startY + rows * spacing + 20;
      const bucketHeight = 60;

      const colors = ['#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#22c55e', '#f97316', '#f97316', '#f97316', '#f97316', '#f97316', '#22c55e', '#84cc16', '#eab308', '#f59e0b', '#f97316', '#ef4444'];
      
      multipliers.forEach((mult, i) => {
        ctx.fillStyle = colors[i];
        ctx.fillRect(i * bucketWidth, bucketY, bucketWidth, bucketHeight);
        ctx.strokeStyle = '#1a1a1a';
        ctx.lineWidth = 2;
        ctx.strokeRect(i * bucketWidth, bucketY, bucketWidth, bucketHeight);
      });
    }

    // Drop ball animation
    let activeBalls = []; // Track all active balls

    function dropBall() {
      const betAmount = parseInt(document.getElementById('betAmount').value);
      if (betAmount > balance || betAmount < 10) {
        alert('Invalid bet amount!');
        return;
      }

      balance -= betAmount;
      totalWagered += betAmount;
      ballsDropped++;
      
      // Sync balance with main.js userCoins
      if (typeof userCoins !== 'undefined') {
        userCoins = balance;
      }
      
      // Update backend if logged in
      if (typeof updateCoins === 'function') {
        updateCoins(-betAmount, 'plinko', 'bet');
      }

      // Create new ball object
      const ball = {
        x: startX + (Math.random() - 0.5) * 20,
        y: startY,
        vx: 0,
        vy: 0,
        betAmount: betAmount,
        active: true
      };

      activeBalls.push(ball);
      
      // Start animation loop if not already running
      if (activeBalls.length === 1) {
        animateAllBalls();
      }
      
      updateUI();
    }

    function animateAllBalls() {
      if (activeBalls.length === 0) return;

      // Update physics for all balls
      activeBalls.forEach(ball => {
        if (!ball.active) return;

        // Physics simulation - MUCH SLOWER GRAVITY AND FRICTION FOR BETTER VISIBILITY
        ball.vy += 0.2; // reduced from 0.3 - even slower fall for better gameplay
        ball.y += ball.vy;
        ball.x += ball.vx;

        // Check collisions with OTHER BALLS (new feature!)
        activeBalls.forEach(otherBall => {
          if (ball === otherBall || !otherBall.active) return;
          
          const dx = ball.x - otherBall.x;
          const dy = ball.y - otherBall.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const minDist = ballRadius * 2;
          
          if (dist < minDist && dist > 0) {
            // Balls are colliding - bounce them apart
            const angle = Math.atan2(dy, dx);
            const targetX = otherBall.x + Math.cos(angle) * minDist;
            const targetY = otherBall.y + Math.sin(angle) * minDist;
            
            // Move balls apart
            ball.x = targetX;
            ball.y = targetY;
            
            // Exchange some velocity (elastic collision)
            const vxTotal = ball.vx + otherBall.vx;
            const vyTotal = ball.vy + otherBall.vy;
            ball.vx = vxTotal * 0.5;
            ball.vy = vyTotal * 0.5;
            otherBall.vx = vxTotal * 0.5;
            otherBall.vy = vyTotal * 0.5;
          }
        });

        // Check collisions with pegs
        for (let row = 0; row < rows; row++) {
          const pegsInRow = row + 3;
          const rowY = startY + row * spacing;
          const rowStartX = startX - (pegsInRow - 1) * spacing / 2;
          
          for (let col = 0; col < pegsInRow; col++) {
            const pegX = rowStartX + col * spacing;
            const dx = ball.x - pegX;
            const dy = ball.y - rowY;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (dist < pegRadius + ballRadius) {
              // Bounce with reduced force
              const angle = Math.atan2(dy, dx);
              ball.vx = Math.cos(angle) * 1.5 * (Math.random() > 0.5 ? 1 : -1); // reduced from 2 to 1.5
              ball.vy = Math.abs(ball.vy) * 0.4; // more friction on bounce (reduced from 0.5 to 0.4)
              ball.y = rowY + Math.sin(angle) * (pegRadius + ballRadius);
              ball.x = pegX + Math.cos(angle) * (pegRadius + ballRadius);
            }
          }
        }

        // Check if ball reached bottom
        const bucketY = startY + rows * spacing + 20;
        if (ball.y > bucketY - 10) {
          // Determine which bucket
          const bucketIndex = Math.floor((ball.x / canvas.width) * 17);
          const clampedIndex = Math.max(0, Math.min(16, bucketIndex));
          const multiplier = multipliers[clampedIndex];
          const winAmount = Math.floor(ball.betAmount * multiplier);
          const profit = winAmount - ball.betAmount;
          
          balance += winAmount;
          totalWon += winAmount;
          
          // Update backend if logged in
          if (typeof updateCoins === 'function') {
            if (profit > 0) {
              updateCoins(profit, 'plinko', 'win');
            }
          }
          
          // Add to history
          addHistory(ball.betAmount, multiplier, winAmount);
          
          // Sync balance with main.js userCoins
          if (typeof userCoins !== 'undefined') {
            userCoins = balance;
          }
          
          updateUI();
          
          ball.active = false;
        }
      });

      // Remove inactive balls
      activeBalls = activeBalls.filter(ball => ball.active);

      // Redraw everything
      drawBoard();
      
      // Draw all active balls
      activeBalls.forEach(ball => {
        ctx.fillStyle = '#ef4444';
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ballRadius, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
      });

      // Continue animation if there are still balls
      if (activeBalls.length > 0) {
        requestAnimationFrame(animateAllBalls);
      }
    }

    // Add to history
    function addHistory(bet, multiplier, won) {
      const history = document.getElementById('history');
      const profit = won - bet;
      const isWin = profit > 0;
      
      // Get current time for better visibility
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `
        <div>
          <div class="history-multiplier ${isWin ? 'win' : 'loss'}">${multiplier}x</div>
          <div style="font-size: 12px; opacity: 0.8; margin-top: 5px; color: #cbd5e1;">üïê ${timeStr}</div>
          <div style="font-size: 12px; opacity: 0.8; margin-top: 3px; color: #94a3b8;">Bet: ‚Çø${bet}</div>
        </div>
        <div class="history-amount ${isWin ? 'profit' : 'loss'}">${isWin ? '+' : ''}‚Çø${profit}</div>
      `;

      history.insertBefore(item, history.firstChild);

      // Keep only last 50 items
      while (history.children.length > 50) {
        history.removeChild(history.lastChild);
      }
    }

    // Update UI
    function updateUI() {
      document.getElementById('balance').textContent = balance;
      document.getElementById('totalWagered').textContent = totalWagered;
      document.getElementById('totalWon').textContent = totalWon;
      document.getElementById('ballsDropped').textContent = ballsDropped;
      
      const betAmount = parseInt(document.getElementById('betAmount').value) || 100;
      const maxMultiplier = Math.max(...multipliers);
      document.getElementById('maxWin').textContent = betAmount * maxMultiplier;
    }

    // Bet controls
    function multiplyBet(factor) {
      const input = document.getElementById('betAmount');
      input.value = Math.floor(parseInt(input.value) * factor);
      updateUI();
    }

    function allIn() {
      document.getElementById('betAmount').value = balance;
      updateUI();
    }

    function placeBet() {
      dropBall();
    }

    function resetGame() {
      balance = 1000;
      totalWagered = 0;
      totalWon = 0;
      ballsDropped = 0;
      document.getElementById('history').innerHTML = '';
      updateUI();
    }

    // Event listeners
    document.getElementById('betAmount').addEventListener('input', updateUI);

    // Initialize game - wait for DOM and auth to be ready
    document.addEventListener('DOMContentLoaded', () => {
      // Load balance from auth system first
      if (typeof userCoins !== 'undefined') {
        balance = userCoins;
      }
      
      // Then initialize the game
      init();
      updateUI();
    });
  </script>
</body>
</html>
