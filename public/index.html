<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GameHub - Premium Gaming Experience</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Modern Server Creation UI Styles */
    .create-server-modal {
      max-width: 800px;
      margin: 0 auto;
    }

    .server-config-grid {
      display: grid;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .config-section {
      background: var(--bg-card-hover);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: 1.5rem;
      transition: all 0.3s;
    }

    .config-section:hover {
      border-color: #1e40af;
      box-shadow: 0 4px 20px rgba(30, 64, 175, 0.1);
    }

    .config-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-primary);
      font-weight: bold;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .label-icon {
      font-size: 1.2rem;
    }

    .game-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .game-option {
      background: #f3f4f6;
      border: 2px solid #d1d5db;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      color: #1f2937;
      user-select: none;
    }

    .game-option:hover {
      transform: translateY(-2px);
      border-color: #1e40af;
      box-shadow: 0 4px 15px rgba(30, 64, 175, 0.2);
      background: #e5e7eb;
    }

    .game-option.selected {
      background: linear-gradient(135deg, #1e40af, #3730a3);
      border-color: #1e40af;
      color: white;
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(30, 64, 175, 0.4);
    }

    .game-emoji {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      display: block;
    }

    .game-name {
      font-size: 0.9rem;
      font-weight: bold;
      display: block;
    }

    .modern-input {
      width: 100%;
      padding: 1rem 1rem 1rem 3rem;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.3s;
    }

    .modern-input:focus {
      outline: none;
      border-color: #1e40af;
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }

    .modern-textarea {
      width: 100%;
      padding: 1rem;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      background: var(--bg-card);
      color: var(--text-primary);
      font-size: 1rem;
      resize: vertical;
      transition: all 0.3s;
    }

    .modern-textarea:focus {
      outline: none;
      border-color: #1e40af;
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
    }

    .input-group {
      position: relative;
      margin-bottom: 1rem;
    }

    .input-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 1.2rem;
      color: var(--text-secondary);
      pointer-events: none;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .toggle-group {
      margin-bottom: 1rem;
    }

    .toggle-label {
      display: flex;
      align-items: center;
      gap: 1rem;
      cursor: pointer;
      color: var(--text-primary);
    }

    .toggle-label input[type="checkbox"] {
      display: none;
    }

    .toggle-slider {
      width: 50px;
      height: 26px;
      background: var(--border-color);
      border-radius: 13px;
      position: relative;
      transition: all 0.3s;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: all 0.3s;
    }

    .toggle-label input[type="checkbox"]:checked + .toggle-slider {
      background: #1e40af;
    }

    .toggle-label input[type="checkbox"]:checked + .toggle-slider::before {
      transform: translateX(24px);
    }

    .toggle-text {
      font-size: 0.9rem;
    }

    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }

    .btn-primary-create {
      background: linear-gradient(135deg, #1e40af, #3730a3);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary-create:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(30, 64, 175, 0.4);
    }

    .btn-secondary {
      background: var(--bg-card-hover);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
      padding: 1rem 2rem;
      border-radius: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      border-color: #1e40af;
      background: rgba(30, 64, 175, 0.1);
    }

    .btn-icon {
      font-size: 1.1rem;
    }

    /* Server Management Panel */
    .server-management-panel {
      background: var(--bg-card-hover);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    .server-owner-badge {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
      display: inline-block;
      margin-left: 0.5rem;
    }

    .server-controls-dropdown {
      position: relative;
      display: inline-block;
    }

    .server-controls-btn {
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }

    .server-controls-btn:hover {
      border-color: #1e40af;
    }

    .server-controls-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: var(--bg-card);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem;
      min-width: 200px;
      z-index: 1000;
      display: none;
    }

    .server-controls-menu.show {
      display: block;
    }

    .server-control-item {
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
      color: var(--text-primary);
    }

    .server-control-item:hover {
      background: var(--bg-card-hover);
    }

    @media (max-width: 768px) {
      .input-row {
        grid-template-columns: 1fr;
      }
      
      .game-selector {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .modal-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body class="dark-theme">
  <header class="header-dark">
    <div class="header-container">
      <div class="logo">
        <h1>üéÆ GAMEHUB</h1>
      </div>
      <div id="authSection" class="auth-buttons"></div>
    </div>
  </header>

  <main class="container-dark">
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-content">
        <h1 class="hero-title">Welcome to GameHub</h1>
        <p class="hero-subtitle">Premium collection of 16 handcrafted games with betting & rewards</p>
      </div>
      <div id="userInfo" class="user-banner">
        <p>üéØ Login or Register to unlock betting, rewards & leaderboards!</p>
      </div>
    </section>

    <!-- Multiplayer Server Selection Section -->
    <section class="server-section">
      <div class="section-header">
        <h2><span class="section-icon">üéÆ</span> Multiplayer Servers</h2>
        <span class="section-count" id="serverCount">0 Active</span>
      </div>
      
      <div class="server-controls">
        <button class="create-server-btn" onclick="showCreateServerModal()">
          <span class="btn-icon">‚ûï</span>
          <span>Create Server</span>
        </button>
        <button class="refresh-servers-btn" onclick="refreshServers()">
          <span class="btn-icon">üîÑ</span>
          <span>Refresh</span>
        </button>
      </div>

      <div class="servers-container" id="serversContainer">
        <div class="no-servers-message">
          <div class="no-servers-icon">üéØ</div>
          <h3>No Active Servers</h3>
          <p>Be the first to create a multiplayer game server!</p>
        </div>
      </div>
    </section>

    <!-- Classic Games Section -->
    <section class="games-section-dark">
      <div class="section-header">
        <h2><span class="section-icon">üïπÔ∏è</span> Classic Arcade</h2>
        <span class="section-count">5 Games</span>
      </div>
      <div class="games-grid-modern">
        <div class="game-card-modern classic">
          <div class="card-banner">
            <span class="game-icon">üêç</span>
            <span class="difficulty easy">Easy</span>
          </div>
          <div class="card-content">
            <h3>Snake</h3>
            <p class="game-desc">Classic arcade snake game. Eat, grow, survive!</p>
            <div class="game-tags">
              <span class="tag">Arcade</span>
              <span class="tag">Retro</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/snake.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern classic">
          <div class="card-banner">
            <span class="game-icon">üê¶</span>
            <span class="difficulty medium">Medium</span>
          </div>
          <div class="card-content">
            <h3>Flappy Bird</h3>
            <p class="game-desc">Tap to fly through pipes. Test your reflexes!</p>
            <div class="game-tags">
              <span class="tag">Arcade</span>
              <span class="tag">Skill</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/flappy-bird.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern classic">
          <div class="card-banner">
            <span class="game-icon">üß†</span>
            <span class="difficulty easy">Easy</span>
          </div>
          <div class="card-content">
            <h3>Memory Match</h3>
            <p class="game-desc">Find matching pairs. Train your memory!</p>
            <div class="game-tags">
              <span class="tag">Puzzle</span>
              <span class="tag">Brain</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/memory.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern classic">
          <div class="card-banner">
            <span class="game-icon">üî¢</span>
            <span class="difficulty medium">Medium</span>
          </div>
          <div class="card-content">
            <h3>2048</h3>
            <p class="game-desc">Merge tiles to reach 2048. Addictive puzzle!</p>
            <div class="game-tags">
              <span class="tag">Puzzle</span>
              <span class="tag">Strategy</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/2048.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern classic">
          <div class="card-banner">
            <span class="game-icon">üêî</span>
            <span class="difficulty hard">Hard</span>
          </div>
          <div class="card-content">
            <h3>Crossy Road</h3>
            <p class="game-desc">Cross roads & rivers. Don't get hit!</p>
            <div class="game-tags">
              <span class="tag">Arcade</span>
              <span class="tag">Action</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/crossy-road.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Multiplayer Games Section -->
    <section class="games-section-dark">
      <div class="section-header">
        <h2><span class="section-icon">üéØ</span> Multiplayer Arena</h2>
        <span class="section-count">4 Games</span>
      </div>
      <div class="games-grid-modern">
        <div class="game-card-modern multiplayer">
          <div class="card-banner">
            <span class="game-icon">‚ùå‚≠ï</span>
            <span class="difficulty easy">Easy</span>
          </div>
          <div class="card-content">
            <h3>Tic Tac Toe</h3>
            <p class="game-desc">Classic X & O. Beat your opponent online!</p>
            <div class="game-tags">
              <span class="tag">Multiplayer</span>
              <span class="tag">Quick</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/tic-tac-toe.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern multiplayer">
          <div class="card-banner">
            <span class="game-icon">üé£</span>
            <span class="difficulty easy">Easy</span>
          </div>
          <div class="card-content">
            <h3>Go Fish</h3>
            <p class="game-desc">Classic card game. Match pairs & collect sets!</p>
            <div class="game-tags">
              <span class="tag">Cards</span>
              <span class="tag">Casual</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/go-fish.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern multiplayer">
          <div class="card-banner">
            <span class="game-icon">üé¥</span>
            <span class="difficulty medium">Medium</span>
          </div>
          <div class="card-content">
            <h3>UNO</h3>
            <p class="game-desc">Match colors & numbers. First to empty wins!</p>
            <div class="game-tags">
              <span class="tag">Cards</span>
              <span class="tag">Strategy</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/uno.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern multiplayer">
          <div class="card-banner">
            <span class="game-icon">üÉè</span>
            <span class="difficulty hard">Hard</span>
          </div>
          <div class="card-content">
            <h3>Poker</h3>
            <p class="game-desc">Texas Hold'em. Bluff, bet & win big!</p>
            <div class="game-tags">
              <span class="tag">Cards</span>
              <span class="tag">Betting</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/poker.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Casino Games Section -->
    <section class="games-section-dark">
      <div class="section-header">
        <h2><span class="section-icon">üé∞</span> Casino & Betting</h2>
        <span class="section-count">7 Games</span>
      </div>
      <div class="games-grid-modern">
        <div class="game-card-modern casino">
          <div class="card-banner">
            <span class="game-icon">üìç</span>
            <span class="difficulty medium">Medium</span>
          </div>
          <div class="card-content">
            <h3>Plinko</h3>
            <p class="game-desc">Drop the ball, watch it bounce. Big rewards!</p>
            <div class="game-tags">
              <span class="tag">Casino</span>
              <span class="tag">Luck</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/plinko.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern casino">
          <div class="card-banner">
            <span class="game-icon">ü™ô</span>
            <span class="difficulty easy">Easy</span>
          </div>
          <div class="card-content">
            <h3>Coin Flip</h3>
            <p class="game-desc">Heads or tails? Double your coins instantly!</p>
            <div class="game-tags">
              <span class="tag">Casino</span>
              <span class="tag">Quick</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/coinflip.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern casino">
          <div class="card-banner">
            <span class="game-icon">üé°</span>
            <span class="difficulty medium">Medium</span>
          </div>
          <div class="card-content">
            <h3>Roulette</h3>
            <p class="game-desc">Spin the wheel. Red, black or number bets!</p>
            <div class="game-tags">
              <span class="tag">Casino</span>
              <span class="tag">Classic</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/roulette.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern casino">
          <div class="card-banner">
            <span class="game-icon">üÇ°</span>
            <span class="difficulty medium">Medium</span>
          </div>
          <div class="card-content">
            <h3>Blackjack 21</h3>
            <p class="game-desc">Beat the dealer. Get 21 without busting!</p>
            <div class="game-tags">
              <span class="tag">Cards</span>
              <span class="tag">Strategy</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/blackjack.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern casino">
          <div class="card-banner">
            <span class="game-icon">üíé</span>
            <span class="difficulty hard">Hard</span>
          </div>
          <div class="card-content">
            <h3>Mines</h3>
            <p class="game-desc">Find diamonds, avoid bombs. High risk, high reward!</p>
            <div class="game-tags">
              <span class="tag">Casino</span>
              <span class="tag">Strategy</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/mines.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern casino">
          <div class="card-banner">
            <span class="game-icon">üé∞</span>
            <span class="difficulty easy">Easy</span>
          </div>
          <div class="card-content">
            <h3>Slots</h3>
            <p class="game-desc">Spin the reels! Match symbols for huge wins!</p>
            <div class="game-tags">
              <span class="tag">Casino</span>
              <span class="tag">Luck</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/slots.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>

        <div class="game-card-modern casino">
          <div class="card-banner">
            <span class="game-icon">üöÄ</span>
            <span class="difficulty medium">Medium</span>
          </div>
          <div class="card-content">
            <h3>Rocket</h3>
            <p class="game-desc">Ride the rocket! Cash out before it crashes!</p>
            <div class="game-tags">
              <span class="tag">Casino</span>
              <span class="tag">Crash</span>
            </div>
          </div>
          <a href="javascript:void(0);" onclick="openGameInContainer('/games/rocket.html')" class="play-btn">
            <span>Play Now</span>
            <span class="btn-arrow">‚Üí</span>
          </a>
        </div>
      </div>
    </section>
  </main>

  <!-- Auth Modal -->
  <div id="authModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <div id="modalContent"></div>
    </div>
  </div>

  <!-- Game Container (displays game in a box with fullscreen toggle) -->
  <div id="gameContainer" class="game-container-wrapper" style="display: none;">
    <div class="game-container-header">
      <h2 id="gameContainerTitle">Game</h2>
      <div class="game-container-controls">
        <button id="fullscreenToggleBtn" class="fullscreen-toggle-btn" onclick="toggleGameFullscreen()">
          <span id="fullscreenToggleText">‚õ∂ Fullscreen</span>
        </button>
        <button class="close-game-btn" onclick="closeGameContainer()">‚úï</button>
      </div>
    </div>
    <div id="gameContainerBox" class="game-container-box">
      <iframe id="gameIframe" class="game-iframe" frameborder="0" allow="fullscreen" allowfullscreen></iframe>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer" class="notification-container"></div>

  <footer class="footer-dark">
    <p>üéÆ GameHub ¬© 2025 | Play Responsibly | 16 Premium Games</p>
  </footer>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="js/main.js"></script>
  <script>
    // Multiplayer Server Management - Constants
    const SOCKET_CONNECTION_DELAY = 1000; // ms to wait for socket connection
    const SERVER_REFRESH_INTERVAL = 10000; // ms between server list refreshes
    
    const MULTIPLAYER_GAMES = [
      { id: 'tic-tac-toe', name: 'Tic Tac Toe', emoji: '‚ùå‚≠ï' },
      { id: 'poker', name: 'Poker', emoji: 'üÉè' },
      { id: 'uno', name: 'UNO', emoji: 'üé¥' },
      { id: 'go-fish', name: 'Go Fish', emoji: 'üé£' }
    ];
    
    const GAME_EMOJIS = Object.fromEntries(
      MULTIPLAYER_GAMES.map(game => [game.id, game.emoji])
    );
    
    // State
    let activeServers = [];
    let gameHubSocket = null;
    
    // Initialize socket connection for multiplayer
    if (typeof io !== 'undefined') {
      socket = io();
      
      socket.on('rooms-list', (data) => {
        console.log('Received rooms-list:', data);
        // Deduplicate by room ID
        const roomMap = new Map();
        (data.rooms || []).forEach(room => {
          roomMap.set(room.id, room);
        });
        activeServers = Array.from(roomMap.values());
        updateServersList();
      });
      
      socket.on('rooms-list-update', (data) => {
        console.log('Received rooms-list-update:', data);
        // Deduplicate by room ID
        const roomMap = new Map();
        (data.rooms || []).forEach(room => {
          roomMap.set(room.id, room);
        });
        activeServers = Array.from(roomMap.values());
        updateServersList();
      });
      
      socket.on('room-created', (data) => {
        // Reset creation lock
        isCreatingServer = false;
        const createBtn = document.querySelector('.btn-primary-create');
        if (createBtn) {
          createBtn.disabled = false;
          createBtn.style.opacity = '1';
        }
        
        if (data.success) {
          showNotification('Server created successfully! üéÆ', 'success');
          closeModal();
          // Don't call refreshServers() - broadcastRoomsUpdate already sends the update
        } else {
          showNotification(data.error || 'Failed to create server', 'error');
          console.error('Room creation failed:', data);
        }
      });
      
      socket.on('room-joined', (data) => {
        if (data.success) {
          showNotification('Joined server successfully! üéÆ', 'success');
          // Redirect to the game
          if (data.room && data.room.gameType) {
            openGameInContainer(`/games/${data.room.gameType}.html`);
          }
        } else {
          showNotification(data.error || 'Failed to join server', 'error');
        }
      });

      socket.on('error', (data) => {
        console.error('Socket error:', data);
        showNotification(data.message || 'Connection error', 'error');
      });
    }
    
    function showCreateServerModal() {
      if (!currentUser) {
        showNotification('Please login to create a server', 'error');
        showLoginModal();
        return;
      }
      
      const modalContent = `
        <div class="create-server-modal">
          <div class="modal-header">
            <h2>üéÆ Create Multiplayer Server</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Set up your custom game server with advanced options</p>
          </div>
          <div class="modal-body">
            <div class="server-config-grid">
              <!-- Game Selection -->
              <div class="config-section">
                <label class="config-label">
                  <span class="label-icon">üéØ</span>
                  Select Game
                </label>
                <div class="game-selector">
                  ${MULTIPLAYER_GAMES.map(game => 
                    `<div class="game-option" onclick="selectGame('${game.id}', event)" data-game="${game.id}">
                      <div class="game-emoji">${game.emoji}</div>
                      <div class="game-name">${game.name}</div>
                    </div>`
                  ).join('')}
                </div>
                <input type="hidden" id="serverGameType" value="">
              </div>

              <!-- Basic Settings -->
              <div class="config-section">
                <label class="config-label">
                  <span class="label-icon">‚öôÔ∏è</span>
                  Server Settings
                </label>
                <div class="input-group">
                  <input type="text" id="serverName" class="modern-input" placeholder="Enter server name..." maxlength="30" value="${currentUser.username}'s Server">
                  <div class="input-icon">üè∑Ô∏è</div>
                </div>
                
                <div class="input-row">
                  <div class="input-group">
                    <select id="maxPlayers" class="modern-input">
                      <option value="2">2 Players</option>
                      <option value="3">3 Players</option>
                      <option value="4" selected>4 Players</option>
                      <option value="6">6 Players</option>
                      <option value="8">8 Players</option>
                    </select>
                    <div class="input-icon">üë•</div>
                  </div>
                  
                  <div class="input-group">
                    <select id="gameMode" class="modern-input">
                      <option value="casual">Casual</option>
                      <option value="competitive">Competitive</option>
                      <option value="tournament">Tournament</option>
                    </select>
                    <div class="input-icon">üèÜ</div>
                  </div>
                </div>
              </div>

              <!-- Advanced Settings -->
              <div class="config-section">
                <label class="config-label">
                  <span class="label-icon">üîß</span>
                  Advanced Options
                </label>
                
                <div class="toggle-group">
                  <label class="toggle-label">
                    <input type="checkbox" id="isPrivate">
                    <span class="toggle-slider"></span>
                    <span class="toggle-text">Private Server (Invite only)</span>
                  </label>
                </div>

                <div class="toggle-group">
                  <label class="toggle-label">
                    <input type="checkbox" id="allowSpectators" checked>
                    <span class="toggle-slider"></span>
                    <span class="toggle-text">Allow Spectators</span>
                  </label>
                </div>

                <div class="toggle-group">
                  <label class="toggle-label">
                    <input type="checkbox" id="autoStart" checked>
                    <span class="toggle-slider"></span>
                    <span class="toggle-text">Auto-start when full</span>
                  </label>
                </div>

                <div class="input-group">
                  <input type="password" id="serverPassword" class="modern-input" placeholder="Server password (optional)">
                  <div class="input-icon">üîí</div>
                </div>
              </div>

              <!-- Server Rules -->
              <div class="config-section">
                <label class="config-label">
                  <span class="label-icon">üìã</span>
                  Server Rules
                </label>
                <textarea id="serverRules" class="modern-textarea" placeholder="Enter server rules (optional)..." rows="3"></textarea>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="modal-actions">
              <button onclick="createServer()" class="btn-primary-create">
                <span class="btn-icon">üöÄ</span>
                Create Server
              </button>
              <button onclick="closeModal()" class="btn-secondary">
                Cancel
              </button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('modalContent').innerHTML = modalContent;
      document.getElementById('authModal').style.display = 'block';
      
      // Initialize first game selection
      if (MULTIPLAYER_GAMES.length > 0) {
        selectGame(MULTIPLAYER_GAMES[0].id);
      }
    }
    
    function selectGame(gameId, event) {
      // Prevent event bubbling issues
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      
      console.log('Selecting game:', gameId);
      
      // Clear previous selection
      document.querySelectorAll('.game-option').forEach(option => {
        option.classList.remove('selected');
      });
      
      // Select new game
      const selectedOption = document.querySelector(`[data-game="${gameId}"]`);
      if (selectedOption) {
        selectedOption.classList.add('selected');
        document.getElementById('serverGameType').value = gameId;
        console.log('Game selected:', gameId);
      }
    }
    
    let isCreatingServer = false; // Prevent duplicate submissions
    
    function createServer() {
      if (!currentUser) {
        showNotification('Please login to create a server', 'error');
        showLoginModal();
        return;
      }

      // Prevent duplicate submissions
      if (isCreatingServer) {
        showNotification('Server creation in progress...', 'warning');
        return;
      }

      const gameType = document.getElementById('serverGameType').value;
      const serverName = document.getElementById('serverName').value || currentUser.username + "'s Server";
      const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
      const gameMode = document.getElementById('gameMode').value;
      const isPrivate = document.getElementById('isPrivate').checked;
      const allowSpectators = document.getElementById('allowSpectators').checked;
      const autoStart = document.getElementById('autoStart').checked;
      const serverPassword = document.getElementById('serverPassword').value;
      const serverRules = document.getElementById('serverRules').value;
      
      if (!gameType) {
        showNotification('Please select a game', 'error');
        return;
      }
      
      console.log('Creating server with:', { 
        gameType, serverName, maxPlayers, gameMode, isPrivate, 
        allowSpectators, autoStart, hasPassword: !!serverPassword 
      });
      
      // Set lock and show loading state
      isCreatingServer = true;
      showNotification('Creating server...', 'info');
      
      // Disable create button during submission
      const createBtn = document.querySelector('.btn-primary-create');
      if (createBtn) {
        createBtn.disabled = true;
        createBtn.style.opacity = '0.5';
      }
      
      // Create room with enhanced settings
      socket.emit('create-room', {
        gameType: gameType,
        playerData: {
          userId: currentUser.id,
          username: currentUser.username,
          coins: userCoins,
          isOwner: true
        },
        settings: {
          name: serverName,
          maxPlayers: maxPlayers,
          isPrivate: isPrivate,
          gameMode: gameMode,
          allowSpectators: allowSpectators,
          autoStart: autoStart,
          password: serverPassword,
          rules: serverRules,
          ownerId: currentUser.id
        }
      });
      
      closeModal();
    }
    
    function refreshServers() {
      if (socket) {
        console.log('Refreshing servers...');
        // Request all servers once (no gameType filter)
        socket.emit('get-rooms', {});
      } else {
        console.warn('Socket not ready for server refresh');
      }
    }
    
    function joinServer(roomId) {
      if (!currentUser) {
        showNotification('Please login to join a server', 'error');
        showLoginModal();
        return;
      }
      
      if (socket) {
        showNotification('Joining server...', 'info');
        socket.emit('join-room', {
          roomId,
          playerData: {
            userId: currentUser.id,
            username: currentUser.username,
            coins: userCoins
          }
        });
      } else {
        showNotification('Connection error. Please refresh the page.', 'error');
      }
    }
    
    function updateServersList() {
      const container = document.getElementById('serversContainer');
      const countEl = document.getElementById('serverCount');
      
      if (!container || !countEl) return;
      
      countEl.textContent = activeServers.length + ' Active';
      
      container.innerHTML = activeServers.map(server => {
        const statusClass = server.status === 'playing' ? 'playing' : 'waiting';
        const statusText = server.status === 'playing' ? 'In Progress' : 'Waiting';
        const isOwner = currentUser && server.settings?.ownerId === currentUser.id;
        const gameInfo = MULTIPLAYER_GAMES.find(g => g.id === server.gameType);
        
        return `
          <div class="server-card ${statusClass}">
            <div class="server-header">
              <div class="server-game">
                ${gameInfo?.emoji || 'üéÆ'} ${server.settings?.name || 'Unnamed Server'}
                ${isOwner ? '<span class="server-owner-badge">OWNER</span>' : ''}
              </div>
              <div class="server-status ${statusClass}">${statusText}</div>
            </div>
            <div class="server-info">
              <div class="server-players">
                <span class="info-icon">üë•</span>
                <span>${server.players.length}/${server.settings.maxPlayers || 2}</span>
              </div>
              <div class="server-host">
                <span class="info-icon">üëë</span>
                <span>${server.host?.username || 'Host'}</span>
              </div>
              ${server.settings?.gameMode ? `
                <div class="server-mode">
                  <span class="info-icon">üèÜ</span>
                  <span>${server.settings.gameMode}</span>
                </div>
              ` : ''}
              ${server.settings?.password ? `
                <div class="server-locked">
                  <span class="info-icon">üîí</span>
                  <span>Private</span>
                </div>
              ` : ''}
            </div>
            <div class="server-actions">
              ${isOwner ? `
                <div class="server-controls-dropdown">
                  <button class="server-controls-btn" onclick="toggleServerMenu('${server.id}')">
                    ‚öôÔ∏è Manage
                  </button>
                  <div id="menu-${server.id}" class="server-controls-menu">
                    <div class="server-control-item" onclick="startServer('${server.id}')">
                      ‚ñ∂Ô∏è Start Game
                    </div>
                    <div class="server-control-item" onclick="kickPlayer('${server.id}')">
                      üë¢ Kick Player
                    </div>
                    <div class="server-control-item" onclick="editServerSettings('${server.id}')">
                      ‚úèÔ∏è Edit Settings
                    </div>
                    <div class="server-control-item" onclick="closeServer('${server.id}')">
                      ‚ùå Close Server
                    </div>
                  </div>
                </div>
              ` : `
                <button 
                  class="join-server-btn" 
                  onclick="joinServer('${server.id}')"
                  ${server.status === 'playing' || server.players.length >= server.maxPlayers ? 'disabled' : ''}
                >
                  ${server.status === 'playing' ? '‚è∏Ô∏è In Progress' : server.players.length >= server.maxPlayers ? 'üîí Full' : '‚ñ∂Ô∏è Join Server'}
                </button>
              `}
            </div>
            ${server.settings?.rules ? `
              <div class="server-rules">
                <strong>Rules:</strong> ${server.settings.rules}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function toggleServerMenu(serverId) {
      const menu = document.getElementById(`menu-${serverId}`);
      // Close all other menus
      document.querySelectorAll('.server-controls-menu').forEach(m => {
        if (m !== menu) m.classList.remove('show');
      });
      // Toggle current menu
      menu.classList.toggle('show');
    }
    
    function startServer(serverId) {
      socket.emit('server-action', {
        action: 'start-game',
        roomId: serverId,
        ownerId: currentUser.id
      });
      showNotification('Starting game...', 'info');
      toggleServerMenu(serverId);
    }
    
    function kickPlayer(serverId) {
      const playerToKick = prompt('Enter username of player to kick:');
      if (playerToKick) {
        socket.emit('server-action', {
          action: 'kick-player',
          roomId: serverId,
          ownerId: currentUser.id,
          targetUsername: playerToKick
        });
        showNotification(`Kicking ${playerToKick}...`, 'info');
      }
      toggleServerMenu(serverId);
    }
    
    function editServerSettings(serverId) {
      showNotification('Edit settings feature coming soon!', 'info');
      toggleServerMenu(serverId);
    }
    
    function closeServer(serverId) {
      if (confirm('Are you sure you want to close this server? All players will be disconnected.')) {
        socket.emit('server-action', {
          action: 'close-server',
          roomId: serverId,
          ownerId: currentUser.id
        });
        showNotification('Closing server...', 'info');
      }
      toggleServerMenu(serverId);
    }
    
    // Load servers on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Small delay to ensure socket is connected
      setTimeout(() => {
        refreshServers();
      }, SOCKET_CONNECTION_DELAY);
      
      // Refresh servers every 10 seconds
      setInterval(refreshServers, SERVER_REFRESH_INTERVAL);
    });

    // ===== GAME CONTAINER FUNCTIONS =====
    
    function openGameInContainer(gameUrl) {
      // Get game name from URL
      const gameName = gameUrl
        .split('/').pop()
        .replace('.html', '')
        .replace(/-/g, ' ')
        .toUpperCase();
      
      // Set up the container
      const container = document.getElementById('gameContainer');
      const iframe = document.getElementById('gameIframe');
      const titleEl = document.getElementById('gameContainerTitle');
      
      titleEl.textContent = 'üéÆ ' + gameName;
      iframe.src = gameUrl;
      
      // Show the container
      container.style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevent scrolling while playing
      
      console.log('Opened game in container:', gameUrl);
    }
    
    function closeGameContainer() {
      const container = document.getElementById('gameContainer');
      const iframe = document.getElementById('gameIframe');
      const btn = document.getElementById('fullscreenToggleBtn');
      
      // Exit fullscreen if active
      if (document.fullscreenElement) {
        document.exitFullscreen().catch(err => console.log('Error exiting fullscreen:', err));
      }
      
      container.style.display = 'none';
      iframe.src = '';
      document.body.style.overflow = '';
      btn.textContent = '‚õ∂ Fullscreen';
      
      console.log('Closed game container');
    }
    
    function toggleGameFullscreen() {
      const container = document.getElementById('gameContainer');
      const gameBox = document.getElementById('gameContainerBox');
      const btn = document.getElementById('fullscreenToggleBtn');
      const iframe = document.getElementById('gameIframe');
      
      if (!document.fullscreenElement) {
        // Enter fullscreen
        gameBox.requestFullscreen().then(() => {
          btn.textContent = '‚õ∂ Exit Fullscreen';
          console.log('Entered fullscreen mode');
        }).catch(err => {
          console.error('Error entering fullscreen:', err);
          showNotification('Could not enter fullscreen mode', 'error');
        });
      } else {
        // Exit fullscreen
        document.exitFullscreen().then(() => {
          btn.textContent = '‚õ∂ Fullscreen';
          console.log('Exited fullscreen mode');
        }).catch(err => {
          console.error('Error exiting fullscreen:', err);
        });
      }
    }
    
    // Listen for fullscreen changes
    document.addEventListener('fullscreenchange', () => {
      const btn = document.getElementById('fullscreenToggleBtn');
      if (document.fullscreenElement) {
        btn.textContent = '‚õ∂ Exit Fullscreen';
      } else {
        btn.textContent = '‚õ∂ Fullscreen';
      }
    });
  </script>
</body>
</html>
