<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Player - YouTube & Spotify</title>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 20px;
        }
        
        .container {
            background: rgba(30, 30, 45, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 40px;
            max-width: 1000px;
            width: 100%;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        /* History Section Styles */
        .history-container {
            background: rgba(30, 30, 45, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 30px;
            max-width: 1000px;
            width: 100%;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .history-header h2 {
            color: #ffffff;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .clear-history-btn {
            padding: 8px 16px;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #ef4444;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .clear-history-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        .history-empty {
            text-align: center;
            padding: 30px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
        }
        
        .history-item {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
        }
        
        .history-item:last-child {
            margin-bottom: 0;
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .history-item-type {
            background: linear-gradient(135deg, #1db954, #1ed760);
            color: #000;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .history-item-date {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
        }
        
        .history-link-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 12px;
            border-radius: 8px;
        }
        
        .history-link-label {
            font-size: 12px;
            font-weight: 600;
            min-width: 70px;
        }
        
        .history-link-label.spotify {
            color: #1db954;
        }
        
        .history-link-label.youtube {
            color: #ff0000;
        }
        
        .history-link-url {
            flex: 1;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: monospace;
        }
        
        .copy-btn {
            padding: 6px 12px;
            background: rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.5);
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .copy-btn:hover {
            background: rgba(139, 92, 246, 0.5);
        }
        
        .copy-btn.copied {
            background: rgba(16, 185, 129, 0.3);
            border-color: rgba(16, 185, 129, 0.5);
            color: #10b981;
        }
        
        .use-link-btn {
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .use-link-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .history-track-count {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Quick Open Section */
        .quick-open-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 12px;
        }
        
        .quick-open-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .quick-open-header h4 {
            color: #a78bfa;
            font-size: 14px;
            margin: 0;
        }
        
        .quick-open-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .quick-open-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .quick-open-item:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        .quick-open-icon {
            font-size: 18px;
        }
        
        .quick-open-info {
            flex: 1;
            min-width: 0;
        }
        
        .quick-open-title {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .quick-open-meta {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            gap: 8px;
        }
        
        .quick-open-play {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .quick-open-play:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .quick-open-empty {
            text-align: center;
            padding: 15px;
            color: rgba(255, 255, 255, 0.4);
            font-size: 13px;
        }
        
        /* Custom Playlist Player Controls */
        .custom-player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }
        
        .player-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .player-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .player-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .player-btn.prev-btn, .player-btn.next-btn {
            padding: 10px 16px;
        }
        
        .player-btn.jump-btn {
            background: rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.5);
        }
        
        .track-indicator {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            min-width: 80px;
            text-align: center;
        }
        
        .player-extras {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .toggle-btn {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .toggle-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        
        .toggle-btn.active {
            background: rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
            color: #a78bfa;
        }
        
        .toggle-btn.shuffle-btn.active {
            background: rgba(34, 197, 94, 0.3);
            border-color: rgba(34, 197, 94, 0.5);
            color: #22c55e;
        }
        
        .track-list-container {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 10px;
        }
        
        .track-list-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .track-list-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        .track-list-container::-webkit-scrollbar-thumb {
            background: rgba(139, 92, 246, 0.5);
            border-radius: 4px;
        }
        
        .track-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .track-item:hover {
            background: rgba(139, 92, 246, 0.2);
        }
        
        .track-item.active {
            background: rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.5);
        }
        
        .track-item.not-found {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .track-number {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            flex-shrink: 0;
        }
        
        .track-item.active .track-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }
        
        .track-info {
            flex: 1;
            min-width: 0;
        }
        
        .track-name {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-artist {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-play-btn {
            padding: 6px 12px;
            background: rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.5);
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .track-item:hover .track-play-btn {
            opacity: 1;
        }
        
        .track-item.not-found .track-play-btn {
            display: none;
        }
        
        .tracklist-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .tracklist-toggle:hover {
            background: rgba(139, 92, 246, 0.2);
        }
        
        h1 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 30px;
            font-size: 32px;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 8px 8px 0 0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: rgba(139, 92, 246, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .tab.active {
            background: rgba(139, 92, 246, 0.2);
            color: #ffffff;
            border-bottom: 2px solid #8b5cf6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.6);
            background: rgba(255, 255, 255, 0.15);
        }
        
        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        button {
            padding: 15px 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .video-container, .spotify-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 15px;
            background: #000;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .spotify-container {
            padding-bottom: 380px; /* Spotify embed height */
            height: auto;
        }
        
        iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 15px;
        }
        
        .error {
            color: #ff6b6b;
            text-align: center;
            padding: 15px;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 12px;
            margin-top: 20px;
            display: none;
            backdrop-filter: blur(10px);
        }
        
        .error.show {
            display: block;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            line-height: 1.6;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .instructions h3 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .instructions ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
        }
        
        .back-link:hover {
            color: #ffffff;
        }
        
        .spotify-info {
            background: rgba(30, 215, 96, 0.1);
            border: 1px solid rgba(30, 215, 96, 0.3);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }
        
        .spotify-info h4 {
            color: #1db954;
            margin-bottom: 8px;
        }
        
        .music-source-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .music-tab {
            padding: 8px 16px;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            border: none;
            border-radius: 6px 6px 0 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
        }
        
        .music-tab:hover {
            background: rgba(139, 92, 246, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .music-tab.active {
            background: rgba(139, 92, 246, 0.15);
            color: #ffffff;
            border-bottom: 2px solid #8b5cf6;
        }
        
        .music-section {
            display: none;
        }
        
        .music-section.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 25px;
                margin: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <a href="/" class="back-link">‚Üê Back to Home</a>
    
    <div class="container">
        <h1>üé¨ Media Player</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('youtube')">üì∫ YouTube</button>
            <button class="tab" onclick="switchTab('spotify')">üéµ Spotify</button>
        </div>
        
        <!-- YouTube Tab -->
        <div id="youtube-tab" class="tab-content active">
            <div class="instructions">
                <h3>How to use:</h3>
                <ul>
                    <li>Paste any YouTube video link (e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ)</li>
                    <li>Or use short links (e.g., https://youtu.be/dQw4w9WgXcQ)</li>
                    <li>Click "Play" to watch the video instantly</li>
                </ul>
            </div>
            
            <div class="input-group">
                <input 
                    type="text" 
                    id="youtubeLink" 
                    placeholder="Paste YouTube video link here..."
                    autocomplete="off"
                >
                <button onclick="playYouTube()">‚ñ∂ Play</button>
            </div>
            
            <div class="error" id="youtubeError"></div>
            
            <div id="youtubeWrapper"></div>
        </div>
        
        <!-- Spotify Tab -->
        <div id="spotify-tab" class="tab-content">
            <div class="spotify-info">
                <h4>üéµ Smart Spotify to YouTube Converter</h4>
                <p><strong>üéØ No Login Required!</strong> Automatically converts Spotify content to YouTube:</p>
                <ul>
                    <li><strong>üéµ Spotify Playlists</strong> - <span style="color: #10b981;">‚úÖ AUTO-CONVERTS</span> - All tracks to YouTube playlist!</li>
                    <li><strong>üíø Spotify Albums</strong> - <span style="color: #10b981;">‚úÖ AUTO-CONVERTS</span> - All tracks to YouTube playlist!</li>
                    <li><strong>üé§ Spotify Artists</strong> - <span style="color: #f59e0b;">‚ö†Ô∏è SEARCHES YOUTUBE</span> - Finds artist on YouTube</li>
                    <li><strong>üé∂ Individual Tracks</strong> - <span style="color: #10b981;">‚úÖ CONVERTS TO YOUTUBE</span> - Full song via YouTube</li>
                </ul>
                <p><em>üí° <strong>Perfect for people without Spotify access!</strong> Paste any Spotify link and play it on YouTube.</em></p>
            </div>
            
            <div class="music-source-tabs">
                <button class="music-tab active" onclick="switchMusicSource('youtube-music')">üéµ YouTube Music</button>
                <button class="music-tab" onclick="switchMusicSource('spotify')">üéµ Spotify</button>
                <button class="music-tab" onclick="switchMusicSource('soundcloud')">üéß SoundCloud</button>
            </div>
            
            <!-- YouTube Music Section -->
            <div id="youtube-music-section" class="music-section active">
                <div class="input-group">
                    <input 
                        type="text" 
                        id="youtubeMusicLink" 
                        placeholder="Paste YouTube Music link (song, album, or playlist)..."
                        autocomplete="off"
                    >
                    <button onclick="playYouTubeMusic()">‚ñ∂ Play</button>
                </div>
                <div class="error" id="youtubeMusicError"></div>
            </div>
            
            <!-- Spotify Section -->
            <div id="spotify-section" class="music-section">
                <div class="input-group">
                    <input 
                        type="text" 
                        id="spotifyLink" 
                        placeholder="Paste Spotify playlist, album, artist, or track link..."
                        autocomplete="off"
                    >
                    <button onclick="playSpotify()">‚ñ∂ Smart Play</button>
                </div>
                <div class="error" id="spotifyError"></div>
                <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 12px; color: rgba(255, 255, 255, 0.8);">
                    ‚ú® <strong>No Spotify? No Problem!</strong> Paste a Spotify playlist URL and watch it convert to YouTube - no login required!
                </div>
                
                <!-- Recently Played Section -->
                <div class="quick-open-section" id="quickOpenSection">
                    <div class="quick-open-header">
                        <h4>‚ö° Recently Played</h4>
                    </div>
                    <div class="quick-open-list" id="quickOpenList">
                        <div class="quick-open-empty">No recently played tracks. Play a converted playlist to see tracks here!</div>
                    </div>
                </div>
            </div>
            
            <!-- SoundCloud Section -->
            <div id="soundcloud-section" class="music-section">
                <div class="input-group">
                    <input 
                        type="text" 
                        id="soundcloudLink" 
                        placeholder="Paste SoundCloud track or playlist link..."
                        autocomplete="off"
                    >
                    <button onclick="playSoundCloud()">‚ñ∂ Play</button>
                </div>
                <div class="error" id="soundcloudError"></div>
            </div>
            
            <div id="musicWrapper"></div>
        </div>
    </div>

    <!-- Conversion History Section -->
    <div class="history-container" id="historyContainer">
        <div class="history-header">
            <h2>üìú Conversion History</h2>
            <button class="clear-history-btn" onclick="clearHistory()">üóëÔ∏è Clear All</button>
        </div>
        <div id="historyList">
            <div class="history-empty">No conversions yet. Convert a Spotify playlist to see it here!</div>
        </div>
    </div>

    <script>
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
        }

        function switchMusicSource(source) {
            // Update music source buttons
            document.querySelectorAll('.music-tab').forEach(t => t.classList.remove('active'));
            
            // Find and activate the correct tab button
            const buttons = document.querySelectorAll('.music-tab');
            buttons.forEach(btn => {
                if (btn.textContent.includes(source === 'youtube-music' ? 'YouTube Music' : 
                    source === 'spotify' ? 'Spotify' : 'SoundCloud')) {
                    btn.classList.add('active');
                }
            });
            
            // Update music sections
            document.querySelectorAll('.music-section').forEach(s => s.classList.remove('active'));
            document.getElementById(source + '-section').classList.add('active');
            
            // Clear previous content
            document.getElementById('musicWrapper').innerHTML = '';
        }

        // YouTube Functions
        function extractYouTubeVideoId(url) {
            let videoId = '';
            
            // Handle youtube.com/watch?v=
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/;
            const youtubeMatch = url.match(youtubeRegex);
            if (youtubeMatch) {
                videoId = youtubeMatch[1];
            }
            
            // Handle youtu.be/
            const shortRegex = /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]{11})/;
            const shortMatch = url.match(shortRegex);
            if (shortMatch) {
                videoId = shortMatch[1];
            }
            
            // Handle just the video ID
            if (/^[a-zA-Z0-9_-]{11}$/.test(url)) {
                videoId = url;
            }
            
            return videoId;
        }

        function playYouTube() {
            const link = document.getElementById('youtubeLink').value.trim();
            const errorMsg = document.getElementById('youtubeError');
            const videoWrapper = document.getElementById('youtubeWrapper');
            
            // Clear previous error
            errorMsg.classList.remove('show');
            errorMsg.textContent = '';
            
            if (!link) {
                errorMsg.textContent = '‚ùå Please enter a YouTube link';
                errorMsg.classList.add('show');
                return;
            }
            
            const videoId = extractYouTubeVideoId(link);
            
            if (!videoId) {
                errorMsg.textContent = '‚ùå Invalid YouTube link. Please check and try again.';
                errorMsg.classList.add('show');
                return;
            }
            
            // Create embed iframe
            const embedUrl = `https://www.youtube.com/embed/${videoId}`;
            videoWrapper.innerHTML = `
                <div class="video-container">
                    <iframe 
                        src="${embedUrl}" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        loading="lazy">
                    </iframe>
                </div>
            `;
        }

        // YouTube Music Functions
        function extractYouTubeMusicId(url) {
            // YouTube Music uses similar URL structure to regular YouTube
            return extractYouTubeVideoId(url);
        }

        async function playYouTubeMusic() {
            const link = document.getElementById('youtubeMusicLink').value.trim();
            const errorMsg = document.getElementById('youtubeMusicError');
            const musicWrapper = document.getElementById('musicWrapper');
            
            // Clear previous error
            errorMsg.classList.remove('show');
            errorMsg.textContent = '';
            
            if (!link) {
                errorMsg.textContent = '‚ùå Please enter a YouTube Music link or search query';
                errorMsg.classList.add('show');
                return;
            }
            
            // First, try to extract video ID (if it's a YouTube URL)
            let videoId = extractYouTubeMusicId(link);
            
            // If not a direct YouTube URL, treat it as a search query
            if (!videoId) {
                musicWrapper.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                        <div style="font-size: 24px; margin-bottom: 10px;">üîç</div>
                        <div>Searching YouTube for: "${link}"</div>
                        <div style="font-size: 12px; margin-top: 10px; opacity: 0.6;">Finding best match...</div>
                    </div>
                `;
                
                try {
                    // Search YouTube via server endpoint
                    const response = await fetch(`/media-player/youtube-search?query=${encodeURIComponent(link)}`);
                    const data = await response.json();
                    
                    if (data.type === 'youtube_video' && data.videoId) {
                        videoId = data.videoId;
                        // Continue to embed the video below
                    } else if (data.searchUrl) {
                        // Fallback: show search results link
                        musicWrapper.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                                <div style="font-size: 24px; margin-bottom: 10px;">üîç</div>
                                <div>${data.message || 'Could not find video automatically'}</div>
                                <a href="${data.searchUrl}" target="_blank" style="display: inline-block; margin-top: 20px; padding: 10px 20px; background: #8b5cf6; color: white; text-decoration: none; border-radius: 8px;">
                                    Open YouTube Search Results
                                </a>
                            </div>
                        `;
                        return;
                    } else {
                        throw new Error('No video ID found');
                    }
                } catch (searchError) {
                    console.error('YouTube search error:', searchError);
                    errorMsg.textContent = '‚ùå Failed to search YouTube. Please enter a direct YouTube URL.';
                    errorMsg.classList.add('show');
                    musicWrapper.innerHTML = '';
                    return;
                }
            }
            
            if (!videoId) {
                errorMsg.textContent = '‚ùå Invalid YouTube Music link. Please check and try again.';
                errorMsg.classList.add('show');
                return;
            }
            
            // Create embed iframe for YouTube Music (same as regular YouTube)
            const embedUrl = `https://www.youtube.com/embed/${videoId}`;
            musicWrapper.innerHTML = `
                <div class="video-container">
                    <iframe 
                        src="${embedUrl}" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        loading="lazy">
                    </iframe>
                </div>
            `;
        }

        // Spotify Functions
        function extractSpotifyId(url) {
            const patterns = {
                track: /(?:https?:\/\/)?(?:open\.)?spotify\.com\/track\/([a-zA-Z0-9]{22})/,
                playlist: /(?:https?:\/\/)?(?:open\.)?spotify\.com\/playlist\/([a-zA-Z0-9]{22})/,
                album: /(?:https?:\/\/)?(?:open\.)?spotify\.com\/album\/([a-zA-Z0-9]{22})/,
                artist: /(?:https?:\/\/)?(?:open\.)?spotify\.com\/artist\/([a-zA-Z0-9]{22})/
            };
            
            for (const [type, pattern] of Object.entries(patterns)) {
                const match = url.match(pattern);
                if (match) {
                    return { type, id: match[1] };
                }
            }
            
            return null;
        }

        async function playSpotify() {
            const link = document.getElementById('spotifyLink').value.trim();
            const errorMsg = document.getElementById('spotifyError');
            const musicWrapper = document.getElementById('musicWrapper');
            
            // Clear previous error
            errorMsg.classList.remove('show');
            errorMsg.textContent = '';
            
            if (!link) {
                errorMsg.textContent = '‚ùå Please enter a Spotify link';
                errorMsg.classList.add('show');
                return;
            }
            
            const spotifyData = extractSpotifyId(link);
            
            if (!spotifyData) {
                errorMsg.textContent = '‚ùå Invalid Spotify link. Please check and try again.';
                errorMsg.classList.add('show');
                return;
            }
            
            // Show loading message
            musicWrapper.innerHTML = `
                <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                    <div style="font-size: 24px; margin-bottom: 10px;">üîÑ</div>
                    <div>Loading Spotify content...</div>
                    <div style="font-size: 12px; margin-top: 10px; opacity: 0.6;">Checking playback availability</div>
                </div>
            `;
            
            try {
                // Check what type of content this is and how to handle it
                const response = await fetch(`/media-player/spotify-to-youtube?spotifyUrl=${encodeURIComponent(link)}`);
                const data = await response.json();
                
                if (data.type === 'youtube_playlist_conversion') {
                    // Playlists/albums are being converted to YouTube - search for each track
                    await convertPlaylistToYouTube(data.tracks, spotifyData, link);
                    return;
                    
                } else if (data.type === 'youtube_playlist_search') {
                    // Playlists/albums fallback - search for YouTube playlist version
                    musicWrapper.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                            <div style="font-size: 24px; margin-bottom: 10px;">üîç</div>
                            <div>${data.message}</div>
                            <div style="font-size: 12px; margin-top: 10px; opacity: 0.6;">Searching for YouTube playlist...</div>
                        </div>
                    `;
                    
                    // Search YouTube for the playlist
                    const playlistQuery = data.query + ' playlist full album';
                    
                    try {
                        const searchResponse = await fetch(`/media-player/youtube-search?query=${encodeURIComponent(playlistQuery)}&type=playlist`);
                        const searchData = await searchResponse.json();
                        
                        if (searchData.type === 'youtube_playlist' && searchData.playlistId) {
                            // Found a YouTube playlist - embed it
                            const playlistEmbedUrl = `https://www.youtube.com/embed/videoseries?list=${searchData.playlistId}`;
                            musicWrapper.innerHTML = `
                                <div class="video-container">
                                    <iframe 
                                        src="${playlistEmbedUrl}" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen
                                        loading="lazy">
                                    </iframe>
                                </div>
                            `;
                            
                            // Save to history
                            saveToHistory(link, playlistEmbedUrl, spotifyData.type, 0);
                            
                            errorMsg.textContent = `‚úÖ Found YouTube playlist: "${searchData.title || data.query}". Full playback available!`;
                            errorMsg.style.background = 'rgba(16, 185, 129, 0.1)';
                            errorMsg.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                            errorMsg.style.color = '#10b981';
                            errorMsg.classList.add('show');
                            setTimeout(() => errorMsg.classList.remove('show'), 8000);
                        } else if (searchData.type === 'youtube_video' && searchData.videoId) {
                            // Found a video (might be a full playlist mix)
                            const videoEmbedUrl = `https://www.youtube.com/embed/${searchData.videoId}`;
                            musicWrapper.innerHTML = `
                                <div class="video-container">
                                    <iframe 
                                        src="${videoEmbedUrl}" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen
                                        loading="lazy">
                                    </iframe>
                                </div>
                            `;
                            
                            // Save to history
                            saveToHistory(link, videoEmbedUrl, spotifyData.type, 0);
                            
                            errorMsg.textContent = `‚úÖ Found YouTube result for "${data.query}". Full playback available!`;
                            errorMsg.style.background = 'rgba(16, 185, 129, 0.1)';
                            errorMsg.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                            errorMsg.style.color = '#10b981';
                            errorMsg.classList.add('show');
                            setTimeout(() => errorMsg.classList.remove('show'), 8000);
                        } else {
                            // Fallback: show search link
                            musicWrapper.innerHTML = `
                                <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.8);">
                                    <div style="font-size: 32px; margin-bottom: 15px;">üîç</div>
                                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Search YouTube for "${data.query}"</div>
                                    <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                                        Click below to find the playlist on YouTube
                                    </div>
                                    <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(playlistQuery)}" target="_blank" 
                                       style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #ff0000, #cc0000); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                                        üéµ Search YouTube
                                    </a>
                                </div>
                            `;
                        }
                    } catch (searchError) {
                        console.error('YouTube playlist search error:', searchError);
                        // Fallback: show manual search option
                        musicWrapper.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.8);">
                                <div style="font-size: 32px; margin-bottom: 15px;">üîç</div>
                                <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Search YouTube for "${data.query}"</div>
                                <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(playlistQuery)}" target="_blank" 
                                   style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #ff0000, #cc0000); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
                                    üéµ Open YouTube Search
                                </a>
                            </div>
                        `;
                    }
                    return;
                    
                } else if (data.type === 'conversion_failed') {
                    // Conversion failed - show helpful message
                    musicWrapper.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.8);">
                            <div style="font-size: 32px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Could Not Convert ${spotifyData.type}</div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                                ${data.message}
                            </div>
                            <div style="background: rgba(139, 92, 246, 0.2); border-radius: 8px; padding: 15px; max-width: 400px; margin: 0 auto; text-align: left;">
                                <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px;">üí° Try this instead:</div>
                                <ol style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8;">
                                    <li>Copy the ${spotifyData.type} name from Spotify</li>
                                    <li>Switch to the YouTube Music tab above</li>
                                    <li>Search for the ${spotifyData.type} name</li>
                                    <li>Play the YouTube version</li>
                                </ol>
                            </div>
                        </div>
                    `;
                    errorMsg.textContent = '‚ö†Ô∏è ' + data.message;
                    errorMsg.style.background = 'rgba(245, 158, 11, 0.1)';
                    errorMsg.style.borderColor = 'rgba(245, 158, 11, 0.3)';
                    errorMsg.style.color = '#f59e0b';
                    errorMsg.classList.add('show');
                    
                } else if (data.type === 'spotify_embed_full') {
                    // Fallback to Spotify embed (shouldn't happen with new implementation)
                    createSpotifyEmbed(link, spotifyData, 'full');
                    errorMsg.textContent = `‚úÖ ${spotifyData.type === 'playlist' ? 'Playlist' : 'Album'} loaded in Spotify embed.`;
                    errorMsg.style.background = 'rgba(29, 185, 84, 0.1)';
                    errorMsg.style.borderColor = 'rgba(29, 185, 84, 0.3)';
                    errorMsg.style.color = '#1db954';
                    errorMsg.classList.add('show');
                    setTimeout(() => errorMsg.classList.remove('show'), 8000);
                    
                } else if (data.type === 'youtube_search') {
                    // Tracks/playlists get converted to YouTube
                    const isPlaylistSearch = data.playlistSearch || spotifyData.type === 'playlist' || spotifyData.type === 'album';
                    
                    musicWrapper.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                            <div style="font-size: 24px; margin-bottom: 10px;">üîÑ</div>
                            <div>${data.message}</div>
                            <div style="font-size: 12px; margin-top: 10px; opacity: 0.6;">
                                ${isPlaylistSearch ? 'Finding YouTube version of this playlist...' : 'Searching YouTube for full song...'}
                            </div>
                        </div>
                    `;
                    
                    // Use the search query from the server response
                    const searchQuery = data.query || await extractSpotifyTrackName(link);
                    
                    if (searchQuery) {
                        // Switch to YouTube Music tab and search for the content
                        switchMusicSource('youtube-music');
                        document.getElementById('youtubeMusicLink').value = searchQuery;
                        await playYouTubeMusic();
                        
                        // Show success message
                        if (isPlaylistSearch) {
                            errorMsg.textContent = `‚úÖ Found YouTube result for: "${searchQuery}". You can play this or search for more results.`;
                            errorMsg.style.background = 'rgba(16, 185, 129, 0.1)';
                            errorMsg.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                            errorMsg.style.color = '#10b981';
                            errorMsg.classList.add('show');
                            setTimeout(() => errorMsg.classList.remove('show'), 8000);
                        }
                        return;
                    }
                    
                    // Fallback if search query is not available
                    errorMsg.textContent = '‚ö†Ô∏è Could not extract search query. Please search YouTube manually.';
                    errorMsg.classList.add('show');
                    
                } else {
                    // Unexpected response type
                    createSpotifyEmbed(link, spotifyData, 'preview');
                    errorMsg.textContent = '‚ö†Ô∏è Using Spotify embed. Log in to Spotify for full playback.';
                    errorMsg.classList.add('show');
                }
                
            } catch (error) {
                console.error('Spotify conversion error:', error);
                errorMsg.textContent = '‚ùå Error processing Spotify link. Please try again.';
                errorMsg.classList.add('show');
            }
        }

        async function convertPlaylistToYouTube(tracks, spotifyData, spotifyUrl) {
            const musicWrapper = document.getElementById('musicWrapper');
            const errorMsg = document.getElementById('spotifyError');
            
            // Show conversion progress
            musicWrapper.innerHTML = `
                <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.9);">
                    <div style="font-size: 32px; margin-bottom: 15px;">üéµ</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Converting Spotify ${spotifyData.type} to YouTube</div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                        Searching YouTube for ${tracks.length} tracks...
                    </div>
                    <div style="background: rgba(139, 92, 246, 0.2); border-radius: 8px; padding: 15px; max-width: 400px; margin: 0 auto;">
                        <div id="conversion-progress" style="font-size: 13px; color: rgba(255,255,255,0.8);">
                            Preparing...
                        </div>
                        <div style="margin-top: 10px; background: rgba(0,0,0,0.3); height: 6px; border-radius: 3px; overflow: hidden;">
                            <div id="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            const progressText = document.getElementById('conversion-progress');
            const progressBar = document.getElementById('progress-bar');
            
            // Store full track data with video IDs
            const playlistData = [];
            
            try {
                // Search YouTube for each track
                let successCount = 0;
                let failCount = 0;
                
                for (let i = 0; i < tracks.length; i++) {
                    const track = tracks[i];
                    const progress = i + 1;
                    const total = tracks.length;
                    const percentage = Math.round((progress / total) * 100);
                    
                    // Update progress text with clear "X out of Y" format
                    progressText.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 5px;">Found ${successCount} out of ${total} songs</div>
                        <div style="font-size: 11px; opacity: 0.8;">Searching: ${track.artist} - ${track.name}</div>
                        <div style="font-size: 11px; opacity: 0.7; margin-top: 3px;">(${progress}/${total} searched ‚Ä¢ ${percentage}% complete)</div>
                    `;
                    progressBar.style.width = `${percentage}%`;
                    
                    try {
                        const videoId = await searchYouTubeClientSide(track.searchQuery);
                        
                        // Store track data with or without videoId
                        playlistData.push({
                            name: track.name,
                            artist: track.artist,
                            videoId: videoId || null,
                            found: !!videoId
                        });
                        
                        if (videoId) {
                            successCount++;
                            console.log(`  ‚úì [${successCount}/${total}] Found: ${videoId} for "${track.searchQuery}"`);
                        } else {
                            failCount++;
                            console.log(`  ‚úó [${i+1}/${total}] Not found: "${track.searchQuery}"`);
                        }
                        
                        // Delay between searches to avoid rate limiting
                        const delay = (i + 1) % 10 === 0 ? 2000 : 800;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } catch (trackError) {
                        failCount++;
                        playlistData.push({
                            name: track.name,
                            artist: track.artist,
                            videoId: null,
                            found: false
                        });
                        console.error(`  ‚úó [${i+1}/${total}] Error for: ${track.searchQuery}`, trackError.message);
                    }
                }
                
                console.log(`\n‚úÖ Search complete: Found ${successCount} out of ${tracks.length} total tracks (${failCount} failed)`);
                
                // Get only found tracks for playback
                const foundTracks = playlistData.filter(t => t.found);
                
                if (foundTracks.length > 0) {
                    const successRate = Math.round((successCount / tracks.length) * 100);
                    progressText.innerHTML = `
                        <div style="font-weight: 600; color: #10b981;">‚úÖ Found ${successCount} out of ${tracks.length} songs!</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">Success rate: ${successRate}% ‚Ä¢ Loading player...</div>
                    `;
                    
                    // Store playlist data globally for navigation
                    window.currentPlaylist = {
                        tracks: playlistData,
                        foundTracks: foundTracks,
                        currentIndex: 0,
                        spotifyUrl: spotifyUrl,
                        type: spotifyData.type
                    };
                    
                    // Create backup YouTube playlist URL (for history)
                    const videoIds = foundTracks.map(t => t.videoId);
                    const playlistParam = videoIds.join(',');
                    const backupEmbedUrl = `https://www.youtube.com/embed/${videoIds[0]}?playlist=${playlistParam}`;
                    
                    setTimeout(() => {
                        // Render custom player
                        renderCustomPlayer(successCount, tracks.length, successRate, failCount);
                        
                        // Save to history with track data for custom player reload
                        saveToHistory(spotifyUrl, backupEmbedUrl, spotifyData.type, foundTracks.length, {
                            tracks: playlistData,
                            foundTracks: foundTracks
                        });
                        
                        errorMsg.textContent = `‚úÖ Successfully loaded ${foundTracks.length} tracks with custom controls!`;
                        errorMsg.style.background = 'rgba(16, 185, 129, 0.1)';
                        errorMsg.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                        errorMsg.style.color = '#10b981';
                        errorMsg.classList.add('show');
                        setTimeout(() => errorMsg.classList.remove('show'), 5000);
                    }, 1000);
                } else {
                    throw new Error('No tracks found on YouTube');
                }
            } catch (conversionError) {
                console.error('Playlist conversion error:', conversionError);
                musicWrapper.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
                        <div>Failed to convert playlist to YouTube</div>
                        <div style="font-size: 12px; margin-top: 10px; opacity: 0.6;">Try using YouTube Music search directly</div>
                    </div>
                `;
                errorMsg.textContent = '‚ùå Playlist conversion failed. Please try YouTube Music search.';
                errorMsg.classList.add('show');
            }
        }
        
        // Render custom player with navigation controls
        function renderCustomPlayer(successCount, totalTracks, successRate, failCount) {
            const musicWrapper = document.getElementById('musicWrapper');
            const playlist = window.currentPlaylist;
            const currentTrack = playlist.foundTracks[playlist.currentIndex];
            
            // Initialize player settings if not set
            if (window.playerSettings === undefined) {
                window.playerSettings = {
                    autoplay: true,
                    shuffle: false,
                    originalOrder: null
                };
            }
            
            musicWrapper.innerHTML = `
                <div id="custom-player-wrapper">
                    <!-- Video Player (YouTube API container) -->
                    <div class="video-container">
                        <div id="youtube-player-container"></div>
                    </div>
                    
                    <!-- Player Controls -->
                    <div class="custom-player-controls">
                        <button class="player-btn prev-btn" onclick="playPreviousTrack()" ${playlist.currentIndex === 0 ? 'disabled' : ''}>
                            ‚èÆÔ∏è Prev
                        </button>
                        <div class="track-indicator">
                            <span id="current-track-num">${playlist.currentIndex + 1}</span> / ${playlist.foundTracks.length}
                        </div>
                        <button class="player-btn next-btn" onclick="playNextTrack()" ${playlist.currentIndex >= playlist.foundTracks.length - 1 && !window.playerSettings.shuffle ? 'disabled' : ''}>
                            Next ‚è≠Ô∏è
                        </button>
                    </div>
                    
                    <!-- Extra Controls (Autoplay & Shuffle) -->
                    <div class="player-extras">
                        <button class="toggle-btn autoplay-btn ${window.playerSettings.autoplay ? 'active' : ''}" onclick="toggleAutoplay()">
                            üîÑ Autoplay ${window.playerSettings.autoplay ? 'ON' : 'OFF'}
                        </button>
                        <button class="toggle-btn shuffle-btn ${window.playerSettings.shuffle ? 'active' : ''}" onclick="toggleShuffle()">
                            üîÄ Shuffle ${window.playerSettings.shuffle ? 'ON' : 'OFF'}
                        </button>
                    </div>
                    
                    <!-- Now Playing -->
                    <div style="text-align: center; margin-top: 10px; padding: 12px; background: rgba(139, 92, 246, 0.15); border-radius: 8px;">
                        <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 4px;">NOW PLAYING</div>
                        <div id="now-playing-title" style="font-size: 14px; font-weight: 600; color: #fff;">${currentTrack.name}</div>
                        <div id="now-playing-artist" style="font-size: 12px; color: rgba(255,255,255,0.7);">${currentTrack.artist}</div>
                    </div>
                    
                    <!-- Tracklist Toggle -->
                    <div class="tracklist-toggle" onclick="toggleTracklist()">
                        <span>üìã</span>
                        <span id="tracklist-toggle-text">Show Tracklist (${playlist.foundTracks.length} songs)</span>
                        <span id="tracklist-arrow">‚ñº</span>
                    </div>
                    
                    <!-- Tracklist (hidden by default) -->
                    <div class="track-list-container" id="tracklist-container" style="display: none;">
                        ${playlist.foundTracks.map((track, index) => {
                            const isActive = index === playlist.currentIndex;
                            const itemClass = isActive ? 'active' : '';
                            
                            return `
                                <div class="track-item ${itemClass}" onclick="jumpToTrack(${index})" data-index="${index}">
                                    <div class="track-number">${index + 1}</div>
                                    <div class="track-info">
                                        <div class="track-name">${track.name}</div>
                                        <div class="track-artist">${track.artist}</div>
                                    </div>
                                    <button class="track-play-btn" onclick="event.stopPropagation(); jumpToTrack(${index})">‚ñ∂ Play</button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Stats -->
                    <div style="margin-top: 15px; padding: 12px; background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; font-size: 13px; color: rgba(255,255,255,0.9); text-align: center;">
                        ‚úÖ <strong>Custom Player Active!</strong> - Auto-advances when song ends<br>
                        <span style="font-size: 12px; opacity: 0.9;">
                            ${successCount} out of ${totalTracks} tracks (${successRate}% success)
                        </span><br>
                        <span style="font-size: 11px; opacity: 0.7;">
                            ${failCount > 0 ? `${failCount} songs couldn't be found on YouTube` : 'All songs found!'}
                        </span>
                    </div>
                </div>
            `;
            
            // Initialize YouTube player with API
            initYouTubePlayer(currentTrack.videoId);
            
            // Save initial track to recently played
            saveRecentlyPlayed(currentTrack);
        }
        
        // Initialize YouTube Player with API for autoplay detection
        function initYouTubePlayer(videoId) {
            // Destroy existing player if any
            if (window.ytPlayer) {
                window.ytPlayer.destroy();
            }
            
            // Create new player
            window.ytPlayer = new YT.Player('youtube-player-container', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    autoplay: 1,
                    modestbranding: 1,
                    rel: 0,
                    enablejsapi: 1
                },
                events: {
                    onStateChange: onPlayerStateChange
                }
            });
        }
        
        // Handle YouTube player state changes
        function onPlayerStateChange(event) {
            // State 0 = video ended
            if (event.data === YT.PlayerState.ENDED) {
                console.log('Video ended, autoplay:', window.playerSettings?.autoplay);
                if (window.playerSettings?.autoplay) {
                    autoPlayNext();
                }
            }
        }
        
        // Auto-play next track (handles shuffle and looping)
        function autoPlayNext() {
            const playlist = window.currentPlaylist;
            if (!playlist) return;
            
            if (window.playerSettings.shuffle) {
                // Pick a random track (different from current)
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * playlist.foundTracks.length);
                } while (randomIndex === playlist.currentIndex && playlist.foundTracks.length > 1);
                
                playlist.currentIndex = randomIndex;
                updatePlayer();
            } else {
                // Normal sequential play
                if (playlist.currentIndex < playlist.foundTracks.length - 1) {
                    playlist.currentIndex++;
                    updatePlayer();
                } else {
                    // End of playlist - loop back to start
                    playlist.currentIndex = 0;
                    updatePlayer();
                }
            }
        }
        
        // Toggle autoplay
        function toggleAutoplay() {
            window.playerSettings.autoplay = !window.playerSettings.autoplay;
            const btn = document.querySelector('.autoplay-btn');
            if (btn) {
                btn.classList.toggle('active', window.playerSettings.autoplay);
                btn.innerHTML = `üîÑ Autoplay ${window.playerSettings.autoplay ? 'ON' : 'OFF'}`;
            }
        }
        
        // Toggle shuffle
        function toggleShuffle() {
            window.playerSettings.shuffle = !window.playerSettings.shuffle;
            const btn = document.querySelector('.shuffle-btn');
            if (btn) {
                btn.classList.toggle('active', window.playerSettings.shuffle);
                btn.innerHTML = `üîÄ Shuffle ${window.playerSettings.shuffle ? 'ON' : 'OFF'}`;
            }
            
            // Update next button state
            const nextBtn = document.querySelector('.next-btn');
            if (nextBtn && window.currentPlaylist) {
                const playlist = window.currentPlaylist;
                nextBtn.disabled = !window.playerSettings.shuffle && playlist.currentIndex >= playlist.foundTracks.length - 1;
            }
        }
        
        // Toggle tracklist visibility
        function toggleTracklist() {
            const container = document.getElementById('tracklist-container');
            const arrow = document.getElementById('tracklist-arrow');
            const text = document.getElementById('tracklist-toggle-text');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                arrow.textContent = '‚ñ≤';
                text.textContent = 'Hide Tracklist';
            } else {
                container.style.display = 'none';
                arrow.textContent = '‚ñº';
                text.textContent = `Show Tracklist (${window.currentPlaylist.foundTracks.length} songs)`;
            }
        }
        
        // Play previous track
        function playPreviousTrack() {
            const playlist = window.currentPlaylist;
            if (playlist.currentIndex > 0) {
                playlist.currentIndex--;
                updatePlayer();
            }
        }
        
        // Play next track
        function playNextTrack() {
            const playlist = window.currentPlaylist;
            
            if (window.playerSettings?.shuffle) {
                // Pick a random track (different from current)
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * playlist.foundTracks.length);
                } while (randomIndex === playlist.currentIndex && playlist.foundTracks.length > 1);
                
                playlist.currentIndex = randomIndex;
                updatePlayer();
            } else if (playlist.currentIndex < playlist.foundTracks.length - 1) {
                playlist.currentIndex++;
                updatePlayer();
            }
        }
        
        // Jump to specific track
        function jumpToTrack(index) {
            const playlist = window.currentPlaylist;
            if (index >= 0 && index < playlist.foundTracks.length) {
                playlist.currentIndex = index;
                updatePlayer();
            }
        }
        
        // Update player with current track
        function updatePlayer() {
            const playlist = window.currentPlaylist;
            const currentTrack = playlist.foundTracks[playlist.currentIndex];
            
            // Update YouTube player using API
            if (window.ytPlayer && window.ytPlayer.loadVideoById) {
                window.ytPlayer.loadVideoById(currentTrack.videoId);
            } else {
                // Fallback: reinitialize player
                initYouTubePlayer(currentTrack.videoId);
            }
            
            // Update track indicator
            document.getElementById('current-track-num').textContent = playlist.currentIndex + 1;
            
            // Update now playing
            document.getElementById('now-playing-title').textContent = currentTrack.name;
            document.getElementById('now-playing-artist').textContent = currentTrack.artist;
            
            // Save to recently played
            saveRecentlyPlayed(currentTrack);
            
            // Update button states
            const prevBtn = document.querySelector('.prev-btn');
            const nextBtn = document.querySelector('.next-btn');
            prevBtn.disabled = playlist.currentIndex === 0;
            // Next is always enabled if shuffle is on (loops), otherwise check if at end
            nextBtn.disabled = !window.playerSettings?.shuffle && playlist.currentIndex >= playlist.foundTracks.length - 1;
            
            // Update tracklist active state
            document.querySelectorAll('.track-item').forEach((item, idx) => {
                item.classList.remove('active');
                if (idx === playlist.currentIndex) {
                    item.classList.add('active');
                    // Scroll into view if tracklist is visible
                    const container = document.getElementById('tracklist-container');
                    if (container.style.display !== 'none') {
                        item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });
        }
        
        // Search YouTube using reliable yt-search package (server-side)
        async function searchYouTubeClientSide(query) {
            try {
                // Try multiple search variations for better results
                const searchVariations = [
                    query,                                          // Exact: "Artist Song"
                    query + ' official audio',                      // With official audio
                    query + ' official video',                      // With official video  
                    query + ' lyrics',                              // Lyric video
                    query.replace(/\(feat\..*?\)/gi, '').trim(),   // Remove "(feat. ...)"
                    query.split(' ').slice(0, -1).join(' ')         // Try without last word
                ];
                
                // Try each variation
                for (let i = 0; i < searchVariations.length; i++) {
                    const searchQuery = searchVariations[i];
                    
                    try {
                        const response = await fetch(`/media-player/youtube-search?query=${encodeURIComponent(searchQuery)}`, {
                            signal: AbortSignal.timeout(15000) // Increased timeout
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.type === 'youtube_video' && data.videoId) {
                                if (searchQuery !== query) {
                                    console.log(`    ‚úì Found using variation: "${searchQuery}"`);
                                }
                                return data.videoId;
                            } else if (data.error) {
                                console.log(`    ‚ö† Server error: ${data.error}`);
                            }
                        } else {
                            console.log(`    ‚ö† HTTP ${response.status} for variation ${i + 1}`);
                        }
                        
                        // Small delay between variations
                        if (i < searchVariations.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    } catch (e) {
                        const errMsg = e?.message || e?.toString() || 'Unknown error';
                        console.log(`    ‚ö† Variation ${i + 1} failed: ${errMsg}`);
                        continue;
                    }
                }
                
                return null;
            } catch (error) {
                const errMsg = error?.message || error?.toString() || 'Unknown error';
                console.error(`    ‚úó Search error: ${errMsg}`);
                return null;
            }
        }
        
        async function extractSpotifyTrackName(spotifyUrl) {
            try {
                // Try to get title from Spotify oEmbed API
                const oEmbedUrl = `https://open.spotify.com/oembed?url=${encodeURIComponent(spotifyUrl)}`;
                const response = await fetch(oEmbedUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.title) {
                        return data.title;
                    }
                }
                
                // Fallback: extract from URL
                const patterns = {
                    track: /track\/([a-zA-Z0-9]{22})/,
                    playlist: /playlist\/([a-zA-Z0-9]{22})/,
                    album: /album\/([a-zA-Z0-9]{22})/,
                    artist: /artist\/([a-zA-Z0-9]{22})/
                };
                
                for (const [type, pattern] of Object.entries(patterns)) {
                    const match = spotifyUrl.match(pattern);
                    if (match) {
                        return `spotify ${type} ${match[1]}`;
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Error extracting Spotify track name:', error);
                return null;
            }
        }

        function createSpotifyEmbed(link, spotifyData, mode = 'preview') {
            const musicWrapper = document.getElementById('musicWrapper');
            const errorMsg = document.getElementById('spotifyError');
            
            // Debug logging
            console.log('Creating Spotify embed:', { link, spotifyData, mode });
            
            // Create Spotify embed iframe with proper parameters for full playback
            let embedUrl;
            let height = '380';
            
            switch (spotifyData.type) {
                case 'track':
                    // Tracks always use preview mode
                    embedUrl = `https://open.spotify.com/embed/track/${spotifyData.id}?utm_source=oembed&theme=0`;
                    break;
                case 'playlist':
                    // Try different embed approaches for playlists
                    embedUrl = `https://open.spotify.com/embed/playlist/${spotifyData.id}?utm_source=oembed&theme=0`;
                    height = '520'; // Taller for playlists
                    break;
                case 'album':
                    // Albums with full playback
                    embedUrl = `https://open.spotify.com/embed/album/${spotifyData.id}?utm_source=oembed&theme=0`;
                    height = '520';
                    break;
                case 'artist':
                    // Artist pages with full playback
                    embedUrl = `https://open.spotify.com/embed/artist/${spotifyData.id}?utm_source=oembed&theme=0`;
                    height = '520';
                    break;
            }
            
            console.log('Embed URL:', embedUrl);
            
            musicWrapper.innerHTML = `
                <div class="spotify-container" style="height: auto;">
                    <iframe 
                        id="spotify-iframe"
                        src="${embedUrl}" 
                        allow="encrypted-media; clipboard-write; autoplay; fullscreen; picture-in-picture"
                        loading="lazy"
                        style="height: ${height}px; width: 100%; border: none; border-radius: 12px;"
                        frameborder="0"
                        onload="console.log('Spotify iframe loaded successfully')"
                        onerror="console.error('Spotify iframe failed to load')">
                    </iframe>
                </div>
                ${mode === 'full' && (spotifyData.type === 'playlist' || spotifyData.type === 'album') ? `
                    <div style="margin-top: 15px; padding: 12px; background: rgba(29, 185, 84, 0.15); border: 1px solid rgba(29, 185, 84, 0.3); border-radius: 8px; font-size: 13px; color: rgba(255,255,255,0.9); text-align: center;">
                        <div style="margin-bottom: 5px;">üéµ <strong>Log in to Spotify in the player above for full playback</strong></div>
                        <div style="font-size: 11px; opacity: 0.8;">Click the "Log in" button in the Spotify embed to play all tracks</div>
                    </div>
                ` : ''}
            `;
            
            // Show appropriate message based on mode and content type
            if (mode === 'full') {
                // Full playback for playlists, albums (requires login)
                if (spotifyData.type === 'playlist' || spotifyData.type === 'album') {
                    errorMsg.textContent = `‚úÖ ${spotifyData.type === 'playlist' ? 'Playlist' : 'Album'} loaded! Log in to Spotify in the player above for full playback.`;
                    errorMsg.style.background = 'rgba(29, 185, 84, 0.1)';
                    errorMsg.style.borderColor = 'rgba(29, 185, 84, 0.3)';
                    errorMsg.style.color = '#1db954';
                } else {
                    errorMsg.textContent = '‚úÖ Content loaded in Spotify embed!';
                    errorMsg.style.background = 'rgba(16, 185, 129, 0.1)';
                    errorMsg.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                    errorMsg.style.color = '#10b981';
                }
            } else if (mode === 'preview') {
                // Preview mode for tracks
                if (spotifyData.type === 'track') {
                    errorMsg.textContent = '‚ö†Ô∏è Track preview (30 seconds). Try YouTube Music tab for full song.';
                } else {
                    errorMsg.textContent = '‚ö†Ô∏è Limited playback. Try YouTube Music for full tracks.';
                }
                errorMsg.style.background = 'rgba(245, 158, 11, 0.1)';
                errorMsg.style.borderColor = 'rgba(245, 158, 11, 0.3)';
                errorMsg.style.color = '#f59e0b';
            }
            
            errorMsg.classList.add('show');
            
            // Auto-hide success messages after 8 seconds
            if (mode === 'full') {
                setTimeout(() => {
                    errorMsg.classList.remove('show');
                }, 8000);
            }
        }

        // SoundCloud Functions
        function extractSoundCloudId(url) {
            // SoundCloud URLs can be in various formats
            // We'll use the full URL for embedding
            const soundcloudRegex = /(?:https?:\/\/)?(?:www\.)?soundcloud\.com\/(.+)/;
            const match = url.match(soundcloudRegex);
            if (match) {
                return match[1]; // Return the path part
            }
            return null;
        }

        function playSoundCloud() {
            const link = document.getElementById('soundcloudLink').value.trim();
            const errorMsg = document.getElementById('soundcloudError');
            const musicWrapper = document.getElementById('musicWrapper');
            
            // Clear previous error
            errorMsg.classList.remove('show');
            errorMsg.textContent = '';
            
            if (!link) {
                errorMsg.textContent = '‚ùå Please enter a SoundCloud link';
                errorMsg.classList.add('show');
                return;
            }
            
            const soundcloudPath = extractSoundCloudId(link);
            
            if (!soundcloudPath) {
                errorMsg.textContent = '‚ùå Invalid SoundCloud link. Please check and try again.';
                errorMsg.classList.add('show');
                return;
            }
            
            // Create SoundCloud embed iframe
            const embedUrl = `https://w.soundcloud.com/player/?url=${encodeURIComponent(link)}&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&visual=true`;
            musicWrapper.innerHTML = `
                <div class="spotify-container">
                    <iframe 
                        src="${embedUrl}" 
                        allow="autoplay"
                        loading="lazy"
                        style="height: 380px;">
                    </iframe>
                </div>
            `;
        }
        
        // Allow pressing Enter to play
        document.getElementById('youtubeLink').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                playYouTube();
            }
        });
        
        document.getElementById('youtubeMusicLink').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                playYouTubeMusic();
            }
        });
        
        document.getElementById('spotifyLink').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                playSpotify();
            }
        });
        
        document.getElementById('soundcloudLink').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                playSoundCloud();
            }
        });
        
        // Auto-play if there's a URL in the query parameter
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const youtubeUrl = urlParams.get('youtube');
            const youtubeMusicUrl = urlParams.get('youtubeMusic');
            const spotifyUrl = urlParams.get('spotify');
            const soundcloudUrl = urlParams.get('soundcloud');
            
            if (youtubeUrl) {
                document.getElementById('youtubeLink').value = youtubeUrl;
                playYouTube();
            } else if (youtubeMusicUrl) {
                document.getElementById('youtubeMusicLink').value = youtubeMusicUrl;
                playYouTubeMusic();
            } else if (spotifyUrl) {
                document.getElementById('spotifyLink').value = spotifyUrl;
                switchMusicSource('spotify');
                playSpotify();
            } else if (soundcloudUrl) {
                document.getElementById('soundcloudLink').value = soundcloudUrl;
                switchMusicSource('soundcloud');
                playSoundCloud();
            }
            
            // Load history on page load
            loadHistory();
        });
        
        // ===== HISTORY FUNCTIONS =====
        
        // Save conversion to history
        function saveToHistory(spotifyUrl, youtubeUrl, type, trackCount, trackData = null) {
            const history = JSON.parse(localStorage.getItem('spotifyConversionHistory') || '[]');
            
            // Create history entry
            const entry = {
                id: Date.now(),
                spotifyUrl: spotifyUrl,
                youtubeUrl: youtubeUrl,
                type: type, // 'playlist', 'album', 'track'
                trackCount: trackCount || 0,
                trackData: trackData, // Full track data for custom player
                date: new Date().toISOString()
            };
            
            // Add to beginning of array (newest first)
            history.unshift(entry);
            
            // Keep only last 20 entries
            if (history.length > 20) {
                history.pop();
            }
            
            localStorage.setItem('spotifyConversionHistory', JSON.stringify(history));
            renderHistory();
            renderQuickOpen();
        }
        
        // Load and render history
        function loadHistory() {
            renderHistory();
            renderQuickOpen();
        }
        
        // Render Recently Played section (tracks played from custom player)
        function renderQuickOpen() {
            const quickOpenList = document.getElementById('quickOpenList');
            const recentlyPlayed = JSON.parse(localStorage.getItem('recentlyPlayedTracks') || '[]');
            
            if (recentlyPlayed.length === 0) {
                quickOpenList.innerHTML = '<div class="quick-open-empty">No recently played tracks. Play a converted playlist to see tracks here!</div>';
                return;
            }
            
            // Show last 10 played tracks
            quickOpenList.innerHTML = recentlyPlayed.slice(0, 10).map((track, index) => {
                const timeAgo = getTimeAgo(new Date(track.playedAt));
                
                return `
                    <div class="quick-open-item" onclick="quickPlayTrack('${track.videoId}', '${track.name.replace(/'/g, "\\'")}', '${track.artist.replace(/'/g, "\\'")}')">
                        <span class="quick-open-icon">üéµ</span>
                        <div class="quick-open-info">
                            <div class="quick-open-title">${track.name}</div>
                            <div class="quick-open-meta">
                                <span>${track.artist}</span>
                                <span>‚Ä¢</span>
                                <span>${timeAgo}</span>
                            </div>
                        </div>
                        <button class="quick-open-play" onclick="event.stopPropagation(); quickPlayTrack('${track.videoId}', '${track.name.replace(/'/g, "\\'")}', '${track.artist.replace(/'/g, "\\'")}')">‚ñ∂</button>
                    </div>
                `;
            }).join('');
        }
        
        // Save a played track to recently played history
        function saveRecentlyPlayed(track) {
            if (!track || !track.videoId || !track.name) return;
            
            const recentlyPlayed = JSON.parse(localStorage.getItem('recentlyPlayedTracks') || '[]');
            
            // Remove duplicate if exists (same videoId)
            const filtered = recentlyPlayed.filter(t => t.videoId !== track.videoId);
            
            // Add to beginning
            filtered.unshift({
                videoId: track.videoId,
                name: track.name,
                artist: track.artist || 'Unknown Artist',
                playedAt: new Date().toISOString()
            });
            
            // Keep only last 20 tracks
            if (filtered.length > 20) {
                filtered.pop();
            }
            
            localStorage.setItem('recentlyPlayedTracks', JSON.stringify(filtered));
            renderQuickOpen();
        }
        
        // Quick play a single track from Recently Played
        function quickPlayTrack(videoId, name, artist) {
            const musicWrapper = document.getElementById('musicWrapper');
            
            musicWrapper.innerHTML = `
                <div class="video-container">
                    <iframe 
                        src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        loading="lazy">
                    </iframe>
                </div>
                <div style="text-align: center; margin-top: 10px; padding: 12px; background: rgba(139, 92, 246, 0.15); border-radius: 8px;">
                    <div style="font-size: 11px; color: rgba(255,255,255,0.5); margin-bottom: 4px;">NOW PLAYING</div>
                    <div style="font-size: 14px; font-weight: 600; color: #fff;">${name}</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.7);">${artist}</div>
                </div>
            `;
            
            // Save this play
            saveRecentlyPlayed({ videoId, name, artist });
            
            // Scroll to player
            musicWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Get time ago string
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
        
        // Load playlist from history with custom player
        function loadFromHistory(entryId) {
            const history = JSON.parse(localStorage.getItem('spotifyConversionHistory') || '[]');
            const entry = history.find(e => e.id === entryId);
            
            if (!entry) {
                console.error('History entry not found:', entryId);
                return;
            }
            
            const musicWrapper = document.getElementById('musicWrapper');
            
            // If we have track data, load the custom player
            if (entry.trackData && entry.trackData.foundTracks && entry.trackData.foundTracks.length > 0) {
                // Set up the playlist data globally
                window.currentPlaylist = {
                    tracks: entry.trackData.tracks,
                    foundTracks: entry.trackData.foundTracks,
                    currentIndex: 0,
                    spotifyUrl: entry.spotifyUrl,
                    type: entry.type
                };
                
                // Render custom player
                const successCount = entry.trackData.foundTracks.length;
                const totalTracks = entry.trackData.tracks.length;
                const successRate = Math.round((successCount / totalTracks) * 100);
                const failCount = totalTracks - successCount;
                
                renderCustomPlayer(successCount, totalTracks, successRate, failCount);
                
                // Scroll to player
                musicWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Show success message
                const errorMsg = document.getElementById('spotifyError');
                errorMsg.textContent = `‚úÖ Loaded ${successCount} tracks from history with custom controls!`;
                errorMsg.style.background = 'rgba(16, 185, 129, 0.1)';
                errorMsg.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                errorMsg.style.color = '#10b981';
                errorMsg.classList.add('show');
                setTimeout(() => errorMsg.classList.remove('show'), 3000);
            } else {
                // Fallback: load the YouTube embed URL
                const url = entry.youtubeUrl;
                if (url.includes('youtube.com/embed/')) {
                    musicWrapper.innerHTML = `
                        <div class="video-container">
                            <iframe 
                                src="${url}${url.includes('?') ? '&' : '?'}autoplay=1" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen
                                loading="lazy">
                            </iframe>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; font-size: 13px; color: rgba(255,255,255,0.9); text-align: center;">
                            ‚ö†Ô∏è <strong>Playing from YouTube embed</strong> (older history - no custom controls)
                        </div>
                    `;
                    musicWrapper.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        
        // Render history items
        function renderHistory() {
            const historyList = document.getElementById('historyList');
            const history = JSON.parse(localStorage.getItem('spotifyConversionHistory') || '[]');
            
            if (history.length === 0) {
                historyList.innerHTML = '<div class="history-empty">No conversions yet. Convert a Spotify playlist to see it here!</div>';
                return;
            }
            
            historyList.innerHTML = history.map(entry => {
                const date = new Date(entry.date);
                const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const hasCustomPlayer = entry.trackData && entry.trackData.foundTracks && entry.trackData.foundTracks.length > 0;
                
                return `
                    <div class="history-item">
                        <div class="history-item-header">
                            <span class="history-item-type">${entry.type}</span>
                            <span class="history-item-date">${formattedDate}</span>
                        </div>
                        <div class="history-link-row">
                            <span class="history-link-label spotify">Spotify:</span>
                            <span class="history-link-url" title="${entry.spotifyUrl}">${entry.spotifyUrl}</span>
                            <button class="copy-btn" onclick="copyToClipboard('${entry.spotifyUrl}', this)">üìã Copy</button>
                        </div>
                        <div class="history-link-row">
                            <span class="history-link-label youtube">YouTube:</span>
                            <span class="history-link-url" title="${entry.youtubeUrl}">${entry.youtubeUrl}</span>
                            <button class="copy-btn" onclick="copyToClipboard('${entry.youtubeUrl}', this)">üìã Copy</button>
                            <button class="use-link-btn" onclick="loadFromHistory(${entry.id})">‚ñ∂ Play</button>
                        </div>
                        ${entry.trackCount > 0 ? `<div class="history-track-count">üéµ ${entry.trackCount} tracks ${hasCustomPlayer ? '‚Ä¢ ‚ö° Custom Player' : ''}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Copy text to clipboard
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                
                button.textContent = '‚úÖ Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'üìã Copy';
                    button.classList.remove('copied');
                }, 2000);
            });
        }
        
        // Use YouTube link in the player
        function useYouTubeLink(url) {
            // Check if it's a playlist or video
            const isPlaylist = url.includes('playlist=') || url.includes('list=') || url.includes('videoseries');
            
            // Switch to YouTube tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.tab').classList.add('active'); // First tab is YouTube
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('youtube-tab').classList.add('active');
            
            // Set the URL and play
            document.getElementById('youtubeLink').value = url;
            
            // If it's already an embed URL, extract the info and create embed directly
            if (url.includes('youtube.com/embed/')) {
                const videoWrapper = document.getElementById('youtubeWrapper');
                videoWrapper.innerHTML = `
                    <div class="video-container">
                        <iframe 
                            src="${url}${url.includes('?') ? '&' : '?'}autoplay=1" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen
                            loading="lazy">
                        </iframe>
                    </div>
                `;
            } else {
                playYouTube();
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Clear all history
        function clearHistory() {
            if (confirm('Are you sure you want to clear all conversion history?')) {
                localStorage.removeItem('spotifyConversionHistory');
                renderHistory();
                renderQuickOpen();
            }
        }
    </script>
</body>
</html>
