<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Player - YouTube & Spotify</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(30, 30, 45, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            padding: 40px;
            max-width: 1000px;
            width: 100%;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        h1 {
            text-align: center;
            color: #ffffff;
            margin-bottom: 30px;
            font-size: 32px;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 8px 8px 0 0;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab:hover {
            background: rgba(139, 92, 246, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }
        
        .tab.active {
            background: rgba(139, 92, 246, 0.2);
            color: #ffffff;
            border-bottom: 2px solid #8b5cf6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            transition: all 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.6);
            background: rgba(255, 255, 255, 0.15);
        }
        
        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        button {
            padding: 15px 35px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(102, 126, 234, 0.5);
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .video-container, .spotify-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 15px;
            background: #000;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .spotify-container {
            padding-bottom: 380px; /* Spotify embed height */
            height: auto;
        }
        
        iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 15px;
        }
        
        .error {
            color: #ff6b6b;
            text-align: center;
            padding: 15px;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 12px;
            margin-top: 20px;
            display: none;
            backdrop-filter: blur(10px);
        }
        
        .error.show {
            display: block;
        }
        
        .instructions {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            line-height: 1.6;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .instructions h3 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .instructions ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
        }
        
        .back-link:hover {
            color: #ffffff;
        }
        
        .spotify-info {
            background: rgba(30, 215, 96, 0.1);
            border: 1px solid rgba(30, 215, 96, 0.3);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }
        
        .spotify-info h4 {
            color: #1db954;
            margin-bottom: 8px;
        }
        
        .music-source-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .music-tab {
            padding: 8px 16px;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            border: none;
            border-radius: 6px 6px 0 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 2px solid transparent;
        }
        
        .music-tab:hover {
            background: rgba(139, 92, 246, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .music-tab.active {
            background: rgba(139, 92, 246, 0.15);
            color: #ffffff;
            border-bottom: 2px solid #8b5cf6;
        }
        
        .music-section {
            display: none;
        }
        
        .music-section.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 25px;
                margin: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <a href="/" class="back-link">‚Üê Back to Home</a>
    
    <div class="container">
        <h1>üé¨ Media Player</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('youtube')">üì∫ YouTube</button>
            <button class="tab" onclick="switchTab('spotify')">üéµ Spotify</button>
        </div>
        
        <!-- YouTube Tab -->
        <div id="youtube-tab" class="tab-content active">
            <div class="instructions">
                <h3>How to use:</h3>
                <ul>
                    <li>Paste any YouTube video link (e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ)</li>
                    <li>Or use short links (e.g., https://youtu.be/dQw4w9WgXcQ)</li>
                    <li>Click "Play" to watch the video instantly</li>
                </ul>
            </div>
            
            <div class="input-group">
                <input 
                    type="text" 
                    id="youtubeLink" 
                    placeholder="Paste YouTube video link here..."
                    autocomplete="off"
                >
                <button onclick="playYouTube()">‚ñ∂ Play</button>
            </div>
            
            <div class="error" id="youtubeError"></div>
            
            <div id="youtubeWrapper"></div>
        </div>
        
        <!-- Spotify Tab -->
        <div id="spotify-tab" class="tab-content">
            <div class="spotify-info">
                <h4>üéµ Smart Spotify to YouTube Converter</h4>
                <p><strong>üéØ No Login Required!</strong> Automatically converts Spotify content to YouTube:</p>
                <ul>
                    <li><strong>üéµ Spotify Playlists</strong> - <span style="color: #10b981;">‚úÖ AUTO-CONVERTS</span> - All tracks to YouTube playlist!</li>
                    <li><strong>üíø Spotify Albums</strong> - <span style="color: #10b981;">‚úÖ AUTO-CONVERTS</span> - All tracks to YouTube playlist!</li>
                    <li><strong>üé§ Spotify Artists</strong> - <span style="color: #f59e0b;">‚ö†Ô∏è SEARCHES YOUTUBE</span> - Finds artist on YouTube</li>
                    <li><strong>üé∂ Individual Tracks</strong> - <span style="color: #10b981;">‚úÖ CONVERTS TO YOUTUBE</span> - Full song via YouTube</li>
                </ul>
                <p><em>üí° <strong>Perfect for people without Spotify access!</strong> Paste any Spotify link and play it on YouTube.</em></p>
            </div>
            
            <div class="music-source-tabs">
                <button class="music-tab active" onclick="switchMusicSource('youtube-music')">üéµ YouTube Music</button>
                <button class="music-tab" onclick="switchMusicSource('spotify')">üéµ Spotify</button>
                <button class="music-tab" onclick="switchMusicSource('soundcloud')">üéß SoundCloud</button>
            </div>
            
            <!-- YouTube Music Section -->
            <div id="youtube-music-section" class="music-section active">
                <div class="input-group">
                    <input 
                        type="text" 
                        id="youtubeMusicLink" 
                        placeholder="Paste YouTube Music link (song, album, or playlist)..."
                        autocomplete="off"
                    >
                    <button onclick="playYouTubeMusic()">‚ñ∂ Play</button>
                </div>
                <div class="error" id="youtubeMusicError"></div>
            </div>
            
            <!-- Spotify Section -->
            <div id="spotify-section" class="music-section">
                <div class="input-group">
                    <input 
                        type="text" 
                        id="spotifyLink" 
                        placeholder="Paste Spotify playlist, album, artist, or track link..."
                        autocomplete="off"
                    >
                    <button onclick="playSpotify()">‚ñ∂ Smart Play</button>
                </div>
                <div class="error" id="spotifyError"></div>
                <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 12px; color: rgba(255, 255, 255, 0.8);">
                    ‚ú® <strong>No Spotify? No Problem!</strong> Paste a Spotify playlist URL and watch it convert to YouTube - no login required!
                </div>
            </div>
            
            <!-- SoundCloud Section -->
            <div id="soundcloud-section" class="music-section">
                <div class="input-group">
                    <input 
                        type="text" 
                        id="soundcloudLink" 
                        placeholder="Paste SoundCloud track or playlist link..."
                        autocomplete="off"
                    >
                    <button onclick="playSoundCloud()">‚ñ∂ Play</button>
                </div>
                <div class="error" id="soundcloudError"></div>
            </div>
            
            <div id="musicWrapper"></div>
        </div>
    </div>

    <script>
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
        }

        function switchMusicSource(source) {
            // Update music source buttons
            document.querySelectorAll('.music-tab').forEach(t => t.classList.remove('active'));
            
            // Find and activate the correct tab button
            const buttons = document.querySelectorAll('.music-tab');
            buttons.forEach(btn => {
                if (btn.textContent.includes(source === 'youtube-music' ? 'YouTube Music' : 
                    source === 'spotify' ? 'Spotify' : 'SoundCloud')) {
                    btn.classList.add('active');
                }
            });
            
            // Update music sections
            document.querySelectorAll('.music-section').forEach(s => s.classList.remove('active'));
            document.getElementById(source + '-section').classList.add('active');
            
            // Clear previous content
            document.getElementById('musicWrapper').innerHTML = '';
        }

        // YouTube Functions
        function extractYouTubeVideoId(url) {
            let videoId = '';
            
            // Handle youtube.com/watch?v=
            const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})/;
            const youtubeMatch = url.match(youtubeRegex);
            if (youtubeMatch) {
                videoId = youtubeMatch[1];
            }
            
            // Handle youtu.be/
            const shortRegex = /(?:https?:\/\/)?(?:www\.)?youtu\.be\/([a-zA-Z0-9_-]{11})/;
            const shortMatch = url.match(shortRegex);
            if (shortMatch) {
                videoId = shortMatch[1];
            }
            
            // Handle just the video ID
            if (/^[a-zA-Z0-9_-]{11}$/.test(url)) {
                videoId = url;
            }
            
            return videoId;
        }

        function playYouTube() {
            const link = document.getElementById('youtubeLink').value.trim();
            const errorMsg = document.getElementById('youtubeError');
            const videoWrapper = document.getElementById('youtubeWrapper');
            
            // Clear previous error
            errorMsg.classList.remove('show');
            errorMsg.textContent = '';
            
            if (!link) {
                errorMsg.textContent = '‚ùå Please enter a YouTube link';
                errorMsg.classList.add('show');
                return;
            }
            
            const videoId = extractYouTubeVideoId(link);
            
            if (!videoId) {
                errorMsg.textContent = '‚ùå Invalid YouTube link. Please check and try again.';
                errorMsg.classList.add('show');
                return;
            }
            
            // Create embed iframe
            const embedUrl = `https://www.youtube.com/embed/${videoId}`;
            videoWrapper.innerHTML = `
                <div class="video-container">
                    <iframe 
                        src="${embedUrl}" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        loading="lazy">
                    </iframe>
                </div>
            `;
        }

        // YouTube Music Functions
        function extractYouTubeMusicId(url) {
            // YouTube Music uses similar URL structure to regular YouTube
            return extractYouTubeVideoId(url);
        }

        async function playYouTubeMusic() {
            const link = document.getElementById('youtubeMusicLink').value.trim();
            const errorMsg = document.getElementById('youtubeMusicError');
            const musicWrapper = document.getElementById('musicWrapper');
            
            // Clear previous error
            errorMsg.classList.remove('show');
            errorMsg.textContent = '';
            
            if (!link) {
                errorMsg.textContent = '‚ùå Please enter a YouTube Music link or search query';
                errorMsg.classList.add('show');
                return;
            }
            
            // First, try to extract video ID (if it's a YouTube URL)
            let videoId = extractYouTubeMusicId(link);
            
            // If not a direct YouTube URL, treat it as a search query
            if (!videoId) {
                musicWrapper.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                        <div style="font-size: 24px; margin-bottom: 10px;">üîç</div>
                        <div>Searching YouTube for: "${link}"</div>
                        <div style="font-size: 12px; margin-top: 10px; opacity: 0.6;">Finding best match...</div>
                    </div>
                `;
                
                try {
                    // Search YouTube via server endpoint
                    const response = await fetch(`/media-player/youtube-search?query=${encodeURIComponent(link)}`);
                    const data = await response.json();
                    
                    if (data.type === 'youtube_video' && data.videoId) {
                        videoId = data.videoId;
                        // Continue to embed the video below
                    } else if (data.searchUrl) {
                        // Fallback: show search results link
                        musicWrapper.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                                <div style="font-size: 24px; margin-bottom: 10px;">üîç</div>
                                <div>${data.message || 'Could not find video automatically'}</div>
                                <a href="${data.searchUrl}" target="_blank" style="display: inline-block; margin-top: 20px; padding: 10px 20px; background: #8b5cf6; color: white; text-decoration: none; border-radius: 8px;">
                                    Open YouTube Search Results
                                </a>
                            </div>
                        `;
                        return;
                    } else {
                        throw new Error('No video ID found');
                    }
                } catch (searchError) {
                    console.error('YouTube search error:', searchError);
                    errorMsg.textContent = '‚ùå Failed to search YouTube. Please enter a direct YouTube URL.';
                    errorMsg.classList.add('show');
                    musicWrapper.innerHTML = '';
                    return;
                }
            }
            
            if (!videoId) {
                errorMsg.textContent = '‚ùå Invalid YouTube Music link. Please check and try again.';
                errorMsg.classList.add('show');
                return;
            }
            
            // Create embed iframe for YouTube Music (same as regular YouTube)
            const embedUrl = `https://www.youtube.com/embed/${videoId}`;
            musicWrapper.innerHTML = `
                <div class="video-container">
                    <iframe 
                        src="${embedUrl}" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        loading="lazy">
                    </iframe>
                </div>
            `;
        }

        // Spotify Functions
        function extractSpotifyId(url) {
            const patterns = {
                track: /(?:https?:\/\/)?(?:open\.)?spotify\.com\/track\/([a-zA-Z0-9]{22})/,
                playlist: /(?:https?:\/\/)?(?:open\.)?spotify\.com\/playlist\/([a-zA-Z0-9]{22})/,
                album: /(?:https?:\/\/)?(?:open\.)?spotify\.com\/album\/([a-zA-Z0-9]{22})/,
                artist: /(?:https?:\/\/)?(?:open\.)?spotify\.com\/artist\/([a-zA-Z0-9]{22})/
            };
            
            for (const [type, pattern] of Object.entries(patterns)) {
                const match = url.match(pattern);
                if (match) {
                    return { type, id: match[1] };
                }
            }
            
            return null;
        }

        async function playSpotify() {
            const link = document.getElementById('spotifyLink').value.trim();
            const errorMsg = document.getElementById('spotifyError');
            const musicWrapper = document.getElementById('musicWrapper');
            
            // Clear previous error
            errorMsg.classList.remove('show');
            errorMsg.textContent = '';
            
            if (!link) {
                errorMsg.textContent = '‚ùå Please enter a Spotify link';
                errorMsg.classList.add('show');
                return;
            }
            
            const spotifyData = extractSpotifyId(link);
            
            if (!spotifyData) {
                errorMsg.textContent = '‚ùå Invalid Spotify link. Please check and try again.';
                errorMsg.classList.add('show');
                return;
            }
            
            // Show loading message
            musicWrapper.innerHTML = `
                <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                    <div style="font-size: 24px; margin-bottom: 10px;">üîÑ</div>
                    <div>Loading Spotify content...</div>
                    <div style="font-size: 12px; margin-top: 10px; opacity: 0.6;">Checking playback availability</div>
                </div>
            `;
            
            try {
                // Check what type of content this is and how to handle it
                const response = await fetch(`/media-player/spotify-to-youtube?spotifyUrl=${encodeURIComponent(link)}`);
                const data = await response.json();
                
                if (data.type === 'youtube_playlist_conversion') {
                    // Playlists/albums are being converted to YouTube - search for each track
                    await convertPlaylistToYouTube(data.tracks, spotifyData);
                    return;
                    
                } else if (data.type === 'conversion_failed') {
                    // Conversion failed - show helpful message
                    musicWrapper.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.8);">
                            <div style="font-size: 32px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Could Not Convert ${spotifyData.type}</div>
                            <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                                ${data.message}
                            </div>
                            <div style="background: rgba(139, 92, 246, 0.2); border-radius: 8px; padding: 15px; max-width: 400px; margin: 0 auto; text-align: left;">
                                <div style="font-size: 13px; font-weight: 600; margin-bottom: 10px;">üí° Try this instead:</div>
                                <ol style="margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8;">
                                    <li>Copy the ${spotifyData.type} name from Spotify</li>
                                    <li>Switch to the YouTube Music tab above</li>
                                    <li>Search for the ${spotifyData.type} name</li>
                                    <li>Play the YouTube version</li>
                                </ol>
                            </div>
                        </div>
                    `;
                    errorMsg.textContent = '‚ö†Ô∏è ' + data.message;
                    errorMsg.style.background = 'rgba(245, 158, 11, 0.1)';
                    errorMsg.style.borderColor = 'rgba(245, 158, 11, 0.3)';
                    errorMsg.style.color = '#f59e0b';
                    errorMsg.classList.add('show');
                    
                } else if (data.type === 'spotify_embed_full') {
                    // Fallback to Spotify embed (shouldn't happen with new implementation)
                    createSpotifyEmbed(link, spotifyData, 'full');
                    errorMsg.textContent = `‚úÖ ${spotifyData.type === 'playlist' ? 'Playlist' : 'Album'} loaded in Spotify embed.`;
                    errorMsg.style.background = 'rgba(29, 185, 84, 0.1)';
                    errorMsg.style.borderColor = 'rgba(29, 185, 84, 0.3)';
                    errorMsg.style.color = '#1db954';
                    errorMsg.classList.add('show');
                    setTimeout(() => errorMsg.classList.remove('show'), 8000);
                    
                } else if (data.type === 'youtube_search') {
                    // Tracks/playlists get converted to YouTube
                    const isPlaylistSearch = data.playlistSearch || spotifyData.type === 'playlist' || spotifyData.type === 'album';
                    
                    musicWrapper.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                            <div style="font-size: 24px; margin-bottom: 10px;">üîÑ</div>
                            <div>${data.message}</div>
                            <div style="font-size: 12px; margin-top: 10px; opacity: 0.6;">
                                ${isPlaylistSearch ? 'Finding YouTube version of this playlist...' : 'Searching YouTube for full song...'}
                            </div>
                        </div>
                    `;
                    
                    // Use the search query from the server response
                    const searchQuery = data.query || await extractSpotifyTrackName(link);
                    
                    if (searchQuery) {
                        // Switch to YouTube Music tab and search for the content
                        switchMusicSource('youtube-music');
                        document.getElementById('youtubeMusicLink').value = searchQuery;
                        await playYouTubeMusic();
                        
                        // Show success message
                        if (isPlaylistSearch) {
                            errorMsg.textContent = `‚úÖ Found YouTube result for: "${searchQuery}". You can play this or search for more results.`;
                            errorMsg.style.background = 'rgba(16, 185, 129, 0.1)';
                            errorMsg.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                            errorMsg.style.color = '#10b981';
                            errorMsg.classList.add('show');
                            setTimeout(() => errorMsg.classList.remove('show'), 8000);
                        }
                        return;
                    }
                    
                    // Fallback if search query is not available
                    errorMsg.textContent = '‚ö†Ô∏è Could not extract search query. Please search YouTube manually.';
                    errorMsg.classList.add('show');
                    
                } else {
                    // Unexpected response type
                    createSpotifyEmbed(link, spotifyData, 'preview');
                    errorMsg.textContent = '‚ö†Ô∏è Using Spotify embed. Log in to Spotify for full playback.';
                    errorMsg.classList.add('show');
                }
                
            } catch (error) {
                console.error('Spotify conversion error:', error);
                errorMsg.textContent = '‚ùå Error processing Spotify link. Please try again.';
                errorMsg.classList.add('show');
            }
        }

        async function convertPlaylistToYouTube(tracks, spotifyData) {
            const musicWrapper = document.getElementById('musicWrapper');
            const errorMsg = document.getElementById('spotifyError');
            
            // Show conversion progress
            musicWrapper.innerHTML = `
                <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.9);">
                    <div style="font-size: 32px; margin-bottom: 15px;">üéµ</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Converting Spotify ${spotifyData.type} to YouTube</div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 20px;">
                        Searching YouTube for ${tracks.length} tracks...
                    </div>
                    <div style="background: rgba(139, 92, 246, 0.2); border-radius: 8px; padding: 15px; max-width: 400px; margin: 0 auto;">
                        <div id="conversion-progress" style="font-size: 13px; color: rgba(255,255,255,0.8);">
                            Preparing...
                        </div>
                        <div style="margin-top: 10px; background: rgba(0,0,0,0.3); height: 6px; border-radius: 3px; overflow: hidden;">
                            <div id="progress-bar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            `;
            
            const progressText = document.getElementById('conversion-progress');
            const progressBar = document.getElementById('progress-bar');
            const videoIds = [];
            
            try {
                // Search YouTube for each track
                let successCount = 0;
                let failCount = 0;
                
                for (let i = 0; i < tracks.length; i++) {
                    const track = tracks[i];
                    const progress = i + 1;
                    const total = tracks.length;
                    const percentage = Math.round((progress / total) * 100);
                    
                    // Update progress text with clear "X out of Y" format
                    progressText.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 5px;">Found ${successCount} out of ${total} songs</div>
                        <div style="font-size: 11px; opacity: 0.8;">Searching: ${track.artist} - ${track.name}</div>
                        <div style="font-size: 11px; opacity: 0.7; margin-top: 3px;">(${progress}/${total} searched ‚Ä¢ ${percentage}% complete)</div>
                    `;
                    progressBar.style.width = `${percentage}%`;
                    
                    try {
                        const videoId = await searchYouTubeClientSide(track.searchQuery);
                        
                        if (videoId) {
                            videoIds.push(videoId);
                            successCount++;
                            console.log(`  ‚úì [${successCount}/${total}] Found: ${videoId} for "${track.searchQuery}"`);
                        } else {
                            failCount++;
                            console.log(`  ‚úó [${i+1}/${total}] Not found: "${track.searchQuery}"`);
                        }
                        
                        // Delay between searches to avoid rate limiting
                        // Use longer delay every 10 searches to be extra safe
                        const delay = (i + 1) % 10 === 0 ? 2000 : 800;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } catch (trackError) {
                        failCount++;
                        console.error(`  ‚úó [${i+1}/${total}] Error for: ${track.searchQuery}`, trackError.message);
                    }
                }
                
                console.log(`\n‚úÖ Search complete: Found ${successCount} out of ${tracks.length} total tracks (${failCount} failed)`);
                
                if (videoIds.length > 0) {
                    // Create YouTube playlist with all video IDs
                    const successRate = Math.round((successCount / tracks.length) * 100);
                    progressText.innerHTML = `
                        <div style="font-weight: 600; color: #10b981;">‚úÖ Found ${successCount} out of ${tracks.length} songs!</div>
                        <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">Success rate: ${successRate}% ‚Ä¢ Starting playback...</div>
                    `;
                    
                    // Create YouTube embed with playlist
                    const playlistParam = videoIds.join(',');
                    const embedUrl = `https://www.youtube.com/embed/${videoIds[0]}?playlist=${playlistParam}&autoplay=1`;
                    
                    setTimeout(() => {
                        musicWrapper.innerHTML = `
                            <div class="video-container">
                                <iframe 
                                    src="${embedUrl}" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen
                                    loading="lazy">
                                </iframe>
                            </div>
                            <div style="margin-top: 15px; padding: 12px; background: rgba(16, 185, 129, 0.15); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; font-size: 13px; color: rgba(255,255,255,0.9); text-align: center;">
                                ‚úÖ <strong>YouTube Playlist Created!</strong><br>
                                <span style="font-size: 12px; opacity: 0.9;">
                                    Queued ${videoIds.length} out of ${tracks.length} tracks (${successRate}% success rate)
                                </span><br>
                                <span style="font-size: 11px; opacity: 0.7; margin-top: 5px; display: inline-block;">
                                    ${failCount > 0 ? `${failCount} songs couldn't be found on YouTube` : 'All songs found!'}
                                </span>
                            </div>
                        `;
                        
                        errorMsg.textContent = `‚úÖ Successfully queued ${videoIds.length} out of ${tracks.length} tracks (${successRate}% success)`;
                        errorMsg.style.background = 'rgba(16, 185, 129, 0.1)';
                        errorMsg.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                        errorMsg.style.color = '#10b981';
                        errorMsg.classList.add('show');
                        setTimeout(() => errorMsg.classList.remove('show'), 5000);
                    }, 1000);
                } else {
                    throw new Error('No tracks found on YouTube');
                }
            } catch (conversionError) {
                console.error('Playlist conversion error:', conversionError);
                musicWrapper.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                        <div style="font-size: 24px; margin-bottom: 10px;">‚ùå</div>
                        <div>Failed to convert playlist to YouTube</div>
                        <div style="font-size: 12px; margin-top: 10px; opacity: 0.6;">Try using YouTube Music search directly</div>
                    </div>
                `;
                errorMsg.textContent = '‚ùå Playlist conversion failed. Please try YouTube Music search.';
                errorMsg.classList.add('show');
            }
        }
        
        // Search YouTube using reliable yt-search package (server-side)
        async function searchYouTubeClientSide(query) {
            try {
                // Try multiple search variations for better results
                const searchVariations = [
                    query,                                          // Exact: "Artist Song"
                    query + ' official audio',                      // With official audio
                    query + ' official video',                      // With official video  
                    query + ' lyrics',                              // Lyric video
                    query.replace(/\(feat\..*?\)/gi, '').trim(),   // Remove "(feat. ...)"
                    query.split(' ').slice(0, -1).join(' ')         // Try without last word
                ];
                
                // Try each variation
                for (let i = 0; i < searchVariations.length; i++) {
                    const searchQuery = searchVariations[i];
                    
                    try {
                        const response = await fetch(`/media-player/youtube-search?query=${encodeURIComponent(searchQuery)}`, {
                            signal: AbortSignal.timeout(15000) // Increased timeout
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.type === 'youtube_video' && data.videoId) {
                                if (searchQuery !== query) {
                                    console.log(`    ‚úì Found using variation: "${searchQuery}"`);
                                }
                                return data.videoId;
                            } else if (data.error) {
                                console.log(`    ‚ö† Server error: ${data.error}`);
                            }
                        } else {
                            console.log(`    ‚ö† HTTP ${response.status} for variation ${i + 1}`);
                        }
                        
                        // Small delay between variations
                        if (i < searchVariations.length - 1) {
                            await new Promise(resolve => setTimeout(resolve, 200));
                        }
                    } catch (e) {
                        const errMsg = e?.message || e?.toString() || 'Unknown error';
                        console.log(`    ‚ö† Variation ${i + 1} failed: ${errMsg}`);
                        continue;
                    }
                }
                
                return null;
            } catch (error) {
                const errMsg = error?.message || error?.toString() || 'Unknown error';
                console.error(`    ‚úó Search error: ${errMsg}`);
                return null;
            }
        }
        
        async function extractSpotifyTrackName(spotifyUrl) {
            try {
                // Try to get title from Spotify oEmbed API
                const oEmbedUrl = `https://open.spotify.com/oembed?url=${encodeURIComponent(spotifyUrl)}`;
                const response = await fetch(oEmbedUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.title) {
                        return data.title;
                    }
                }
                
                // Fallback: extract from URL
                const patterns = {
                    track: /track\/([a-zA-Z0-9]{22})/,
                    playlist: /playlist\/([a-zA-Z0-9]{22})/,
                    album: /album\/([a-zA-Z0-9]{22})/,
                    artist: /artist\/([a-zA-Z0-9]{22})/
                };
                
                for (const [type, pattern] of Object.entries(patterns)) {
                    const match = spotifyUrl.match(pattern);
                    if (match) {
                        return `spotify ${type} ${match[1]}`;
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Error extracting Spotify track name:', error);
                return null;
            }
        }

        function createSpotifyEmbed(link, spotifyData, mode = 'preview') {
            const musicWrapper = document.getElementById('musicWrapper');
            const errorMsg = document.getElementById('spotifyError');
            
            // Debug logging
            console.log('Creating Spotify embed:', { link, spotifyData, mode });
            
            // Create Spotify embed iframe with proper parameters for full playback
            let embedUrl;
            let height = '380';
            
            switch (spotifyData.type) {
                case 'track':
                    // Tracks always use preview mode
                    embedUrl = `https://open.spotify.com/embed/track/${spotifyData.id}?utm_source=oembed&theme=0`;
                    break;
                case 'playlist':
                    // Try different embed approaches for playlists
                    embedUrl = `https://open.spotify.com/embed/playlist/${spotifyData.id}?utm_source=oembed&theme=0`;
                    height = '520'; // Taller for playlists
                    break;
                case 'album':
                    // Albums with full playback
                    embedUrl = `https://open.spotify.com/embed/album/${spotifyData.id}?utm_source=oembed&theme=0`;
                    height = '520';
                    break;
                case 'artist':
                    // Artist pages with full playback
                    embedUrl = `https://open.spotify.com/embed/artist/${spotifyData.id}?utm_source=oembed&theme=0`;
                    height = '520';
                    break;
            }
            
            console.log('Embed URL:', embedUrl);
            
            musicWrapper.innerHTML = `
                <div class="spotify-container" style="height: auto;">
                    <iframe 
                        id="spotify-iframe"
                        src="${embedUrl}" 
                        allow="encrypted-media; clipboard-write; autoplay; fullscreen; picture-in-picture"
                        loading="lazy"
                        style="height: ${height}px; width: 100%; border: none; border-radius: 12px;"
                        frameborder="0"
                        onload="console.log('Spotify iframe loaded successfully')"
                        onerror="console.error('Spotify iframe failed to load')">
                    </iframe>
                </div>
                ${mode === 'full' && (spotifyData.type === 'playlist' || spotifyData.type === 'album') ? `
                    <div style="margin-top: 15px; padding: 12px; background: rgba(29, 185, 84, 0.15); border: 1px solid rgba(29, 185, 84, 0.3); border-radius: 8px; font-size: 13px; color: rgba(255,255,255,0.9); text-align: center;">
                        <div style="margin-bottom: 5px;">üéµ <strong>Log in to Spotify in the player above for full playback</strong></div>
                        <div style="font-size: 11px; opacity: 0.8;">Click the "Log in" button in the Spotify embed to play all tracks</div>
                    </div>
                ` : ''}
            `;
            
            // Show appropriate message based on mode and content type
            if (mode === 'full') {
                // Full playback for playlists, albums (requires login)
                if (spotifyData.type === 'playlist' || spotifyData.type === 'album') {
                    errorMsg.textContent = `‚úÖ ${spotifyData.type === 'playlist' ? 'Playlist' : 'Album'} loaded! Log in to Spotify in the player above for full playback.`;
                    errorMsg.style.background = 'rgba(29, 185, 84, 0.1)';
                    errorMsg.style.borderColor = 'rgba(29, 185, 84, 0.3)';
                    errorMsg.style.color = '#1db954';
                } else {
                    errorMsg.textContent = '‚úÖ Content loaded in Spotify embed!';
                    errorMsg.style.background = 'rgba(16, 185, 129, 0.1)';
                    errorMsg.style.borderColor = 'rgba(16, 185, 129, 0.3)';
                    errorMsg.style.color = '#10b981';
                }
            } else if (mode === 'preview') {
                // Preview mode for tracks
                if (spotifyData.type === 'track') {
                    errorMsg.textContent = '‚ö†Ô∏è Track preview (30 seconds). Try YouTube Music tab for full song.';
                } else {
                    errorMsg.textContent = '‚ö†Ô∏è Limited playback. Try YouTube Music for full tracks.';
                }
                errorMsg.style.background = 'rgba(245, 158, 11, 0.1)';
                errorMsg.style.borderColor = 'rgba(245, 158, 11, 0.3)';
                errorMsg.style.color = '#f59e0b';
            }
            
            errorMsg.classList.add('show');
            
            // Auto-hide success messages after 8 seconds
            if (mode === 'full') {
                setTimeout(() => {
                    errorMsg.classList.remove('show');
                }, 8000);
            }
        }

        // SoundCloud Functions
        function extractSoundCloudId(url) {
            // SoundCloud URLs can be in various formats
            // We'll use the full URL for embedding
            const soundcloudRegex = /(?:https?:\/\/)?(?:www\.)?soundcloud\.com\/(.+)/;
            const match = url.match(soundcloudRegex);
            if (match) {
                return match[1]; // Return the path part
            }
            return null;
        }

        function playSoundCloud() {
            const link = document.getElementById('soundcloudLink').value.trim();
            const errorMsg = document.getElementById('soundcloudError');
            const musicWrapper = document.getElementById('musicWrapper');
            
            // Clear previous error
            errorMsg.classList.remove('show');
            errorMsg.textContent = '';
            
            if (!link) {
                errorMsg.textContent = '‚ùå Please enter a SoundCloud link';
                errorMsg.classList.add('show');
                return;
            }
            
            const soundcloudPath = extractSoundCloudId(link);
            
            if (!soundcloudPath) {
                errorMsg.textContent = '‚ùå Invalid SoundCloud link. Please check and try again.';
                errorMsg.classList.add('show');
                return;
            }
            
            // Create SoundCloud embed iframe
            const embedUrl = `https://w.soundcloud.com/player/?url=${encodeURIComponent(link)}&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&visual=true`;
            musicWrapper.innerHTML = `
                <div class="spotify-container">
                    <iframe 
                        src="${embedUrl}" 
                        allow="autoplay"
                        loading="lazy"
                        style="height: 380px;">
                    </iframe>
                </div>
            `;
        }
        
        // Allow pressing Enter to play
        document.getElementById('youtubeLink').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                playYouTube();
            }
        });
        
        document.getElementById('youtubeMusicLink').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                playYouTubeMusic();
            }
        });
        
        document.getElementById('spotifyLink').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                playSpotify();
            }
        });
        
        document.getElementById('soundcloudLink').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                playSoundCloud();
            }
        });
        
        // Auto-play if there's a URL in the query parameter
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const youtubeUrl = urlParams.get('youtube');
            const youtubeMusicUrl = urlParams.get('youtubeMusic');
            const spotifyUrl = urlParams.get('spotify');
            const soundcloudUrl = urlParams.get('soundcloud');
            
            if (youtubeUrl) {
                document.getElementById('youtubeLink').value = youtubeUrl;
                playYouTube();
            } else if (youtubeMusicUrl) {
                document.getElementById('youtubeMusicLink').value = youtubeMusicUrl;
                playYouTubeMusic();
            } else if (spotifyUrl) {
                document.getElementById('spotifyLink').value = spotifyUrl;
                switchMusicSource('spotify');
                playSpotify();
            } else if (soundcloudUrl) {
                document.getElementById('soundcloudLink').value = soundcloudUrl;
                switchMusicSource('soundcloud');
                playSoundCloud();
            }
        });
    </script>
</body>
</html>
